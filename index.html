<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BlissNexus â€” The Five Kingdoms</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:     #060810;
  --bg2:    #0b0d18;
  --bg3:    #10121e;
  --bg4:    #161824;
  --border: #1c1f30;
  --tx:     #b8c4e0;
  --dm:     #363d5a;
  --acc:    #00ff88;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; background:var(--bg); color:var(--tx); font-family:'Inter',sans-serif; overflow:hidden; }

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#app { display:grid; grid-template-columns:1fr 320px; grid-template-rows:56px 1fr; height:100vh; }

/* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hdr {
  grid-column: 1/-1;
  display: flex; align-items: center; padding: 0 20px; gap: 14px;
  background: rgba(6,8,16,.97);
  border-bottom: 1px solid var(--border);
  z-index: 20;
}
.logo {
  font-family: 'Orbitron', monospace; font-size: 1rem; font-weight: 900; letter-spacing:.06em;
  background: linear-gradient(90deg,#00ff88 0%,#4488ff 50%,#ff4488 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}
.logo-sub { font-size:.42rem; color:var(--dm); letter-spacing:.2em; text-transform:uppercase; margin-top:1px; }
#era {
  margin-left: auto;
  font-family: 'Orbitron', monospace; font-size:.5rem; letter-spacing:.1em;
  padding: 4px 14px; border-radius: 20px; border: 1px solid currentColor;
  transition: all .4s;
}
.era-peace  { color:#00cc66; border-color:#00cc6640; background:#00cc6608; }
.era-tense  { color:#ffcc00; border-color:#ffcc0040; background:#ffcc0008; }
.era-war    { color:#ff6600; border-color:#ff660040; background:#ff660010; animation: era-pulse 1.2s ease infinite; }
.era-nuclear{ color:#ff2244; border-color:#ff224460; background:#ff224415; animation: era-pulse .6s ease infinite; }
.era-ended  { color:#662233; border-color:#33111a; background:#1a0810; }
@keyframes era-pulse { 0%,100%{opacity:1} 50%{opacity:.55} }

#live-dot { width:7px; height:7px; border-radius:50%; background:var(--acc); box-shadow:0 0 8px var(--acc); animation:livepulse 1.8s ease infinite; margin-left:8px; }
@keyframes livepulse { 0%,100%{opacity:1;box-shadow:0 0 8px var(--acc)} 50%{opacity:.3;box-shadow:none} }

#reset-btn {
  font-size:.46rem; font-family:'Orbitron',monospace; letter-spacing:.08em;
  padding:4px 12px; border-radius:16px; border:1px solid var(--border);
  background:transparent; color:var(--dm); cursor:pointer; transition:all .15s;
}
#reset-btn:hover { border-color:#ff4488; color:#ff4488; }

/* â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#map-wrap { position:relative; background:#060c14; overflow:hidden; }
#map-canvas { display:block; width:100%; height:100%; image-rendering:pixelated; }

/* Nuke warning banner */
#nuke-warn {
  display:none; position:absolute; top:12px; left:50%; transform:translateX(-50%);
  background:#1a0010; border:1px solid #ff2244; border-radius:8px;
  padding:7px 20px; font-family:'Orbitron',monospace; font-size:.55rem;
  color:#ff2244; letter-spacing:.1em; z-index:10; animation:era-pulse .4s ease infinite;
  white-space:nowrap;
}

/* â”€â”€ RIGHT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#panel {
  background:var(--bg2); border-left:1px solid var(--border);
  display:grid; grid-template-rows:auto 1fr auto;
  overflow:hidden;
}

/* Nation roster */
#roster { border-bottom:1px solid var(--border); }
.king-card {
  display:flex; align-items:center; gap:10px; padding:9px 14px;
  cursor:pointer; border-left:3px solid transparent; transition:all .15s;
  position:relative;
}
.king-card:hover { background:var(--bg3); }
.king-card.sel { background:var(--bg3); border-left-color:var(--kc); }
.king-card.dead { opacity:.3; pointer-events:none; }
.king-card + .king-card { border-top:1px solid var(--border); }
.k-avatar {
  width:34px; height:34px; border-radius:8px; display:flex; align-items:center;
  justify-content:center; font-size:1.1rem; flex-shrink:0;
  background:var(--bg4); border:1px solid var(--border);
}
.k-body { flex:1; min-width:0; }
.k-name { font-size:.62rem; font-weight:600; color:var(--kc,var(--tx)); }
.k-title { font-size:.46rem; color:var(--dm); margin-top:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.k-stats { display:flex; gap:6px; margin-top:4px; }
.k-stat { font-size:.44rem; color:var(--dm); display:flex; align-items:center; gap:2px; }
.k-stat span { color:var(--kc,var(--tx)); font-weight:600; }
.k-war-badge {
  font-size:.38rem; font-family:'Orbitron',monospace; letter-spacing:.06em;
  padding:2px 6px; border-radius:4px; background:#2a0010; color:#ff4444; border:1px solid #ff444440;
}
.k-peace-badge {
  font-size:.38rem; color:var(--dm);
}

/* Chat area */
#chat { display:flex; flex-direction:column; overflow:hidden; }
#chat-hdr {
  padding:11px 14px 9px; border-bottom:1px solid var(--border);
  background:var(--bg3);
}
#chat-king { font-size:.64rem; font-weight:600; }
#chat-sub  { font-size:.46rem; color:var(--dm); margin-top:2px; display:flex; align-items:center; gap:5px; }
.enc-badge { font-size:.38rem; color:#00aa55; letter-spacing:.06em; }

#feed {
  flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px;
}
#feed::-webkit-scrollbar { width:2px; }
#feed::-webkit-scrollbar-thumb { background:var(--border); border-radius:1px; }

.msg { animation:msgin .2s ease; }
@keyframes msgin { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:none} }

.msg-row { display:flex; flex-direction:column; gap:2px; }
.msg-name { font-size:.5rem; font-weight:600; padding:0 2px; }
.msg-bubble {
  font-size:.65rem; line-height:1.6; padding:8px 11px;
  border-radius:3px 10px 10px 10px; border:1px solid var(--border);
  background:var(--bg3); color:var(--tx);
}
.msg.user .msg-bubble {
  background: linear-gradient(135deg,#07180f,#060f18);
  border-color:#00ff8822; border-radius:10px 3px 10px 10px;
}
.msg.user .msg-name { text-align:right; color:#00cc66; }

.event-msg {
  text-align:center; font-size:.53rem; padding:5px 8px;
  border-radius:6px; letter-spacing:.02em;
}
.event-world { color:#8899aa; background:transparent; }
.event-war   { color:#ff6644; background:#1a0800; border:1px solid #ff664420; }
.event-nuke  { color:#ff2244; background:#1a0010; border:1px solid #ff224430; animation:era-pulse .8s ease infinite; }
.event-peace { color:#00cc66; background:#001a0c; border:1px solid #00cc6620; }
.event-alliance { color:#ffcc00; background:#1a1400; border:1px solid #ffcc0020; }
.event-destroyed { color:#ff4444; background:#1a0a0a; border:1px solid #ff444430; }

.typing-row { display:flex; gap:4px; align-items:center; padding:8px 11px; background:var(--bg3); border:1px solid var(--border); border-radius:3px 10px 10px 10px; width:fit-content; }
.tdot { width:5px; height:5px; border-radius:50%; animation:tdot .7s ease infinite; }
.tdot:nth-child(2){animation-delay:.15s} .tdot:nth-child(3){animation-delay:.3s}
@keyframes tdot{0%,60%,100%{opacity:.2;transform:scale(.8)}30%{opacity:1;transform:scale(1.1)}}

/* Input */
#input-wrap {
  padding:10px 12px; border-top:1px solid var(--border);
  display:flex; flex-direction:column; gap:7px;
  background:var(--bg2);
}
#input-label { font-size:.46rem; color:var(--dm); display:flex; align-items:center; gap:6px; }
#input-label .enc { color:#006633; font-family:'Orbitron',monospace; font-size:.38rem; letter-spacing:.06em; }
#msg-input {
  width:100%; background:var(--bg3); border:1px solid var(--border);
  color:var(--tx); padding:8px 11px; border-radius:8px;
  font-family:inherit; font-size:14px; resize:none; height:52px; outline:none;
  transition:border-color .15s;
}
#msg-input:focus { border-color:var(--active-col,#00ff8844); }
#msg-input:disabled { opacity:.3; }
#send-btn {
  padding:7px; border-radius:7px; border:1px solid var(--active-col,#00ff8830);
  background:linear-gradient(135deg,#03180a,#041220); color:var(--active-col,#00cc66);
  font-family:'Orbitron',monospace; font-size:.5rem; letter-spacing:.08em;
  cursor:pointer; transition:all .15s;
}
#send-btn:hover:not(:disabled) { box-shadow:0 0 14px var(--active-col,#00ff8820); }
#send-btn:disabled { opacity:.3; cursor:not-allowed; }

/* Select prompt */
#select-prompt {
  flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center;
  gap:8px; padding:20px; text-align:center;
}
#select-prompt .sp-icon { font-size:2rem; opacity:.3; }
#select-prompt .sp-text { font-size:.6rem; color:var(--dm); line-height:1.6; }

/* Nuke overlay */
#nuke-flash { position:fixed; inset:0; pointer-events:none; z-index:100; display:none; background:radial-gradient(ellipse at center,rgba(255,34,68,.3),transparent 70%); }
</style>
</head>
<body>
<div id="app">

  <!-- Header -->
  <header id="hdr">
    <div>
      <div class="logo">BLISSNEXUS</div>
      <div class="logo-sub">The Five Kingdoms</div>
    </div>
    <div id="era" class="era-peace">ğŸ•Š AGE OF PEACE</div>
    <div id="live-dot"></div>
    <button id="reset-btn" title="Start a new world">â†º NEW WORLD</button>
  </header>

  <!-- Map -->
  <div id="map-wrap">
    <canvas id="map-canvas"></canvas>
    <div id="nuke-warn">â˜¢ NUCLEAR STRIKE INBOUND</div>
  </div>

  <!-- Right panel -->
  <aside id="panel">
    <div id="roster"></div>
    <div id="chat">
      <div id="chat-hdr">
        <div id="chat-king" style="color:var(--dm)">Select a kingdom</div>
        <div id="chat-sub"><span class="enc-badge"></span><span id="chat-sub-text">Click a king to open a private channel</span></div>
      </div>
      <div id="feed">
        <div id="select-prompt">
          <div class="sp-icon">ğŸ—ºï¸</div>
          <div class="sp-text">Click any kingdom on the map<br>or select a king to whisper<br>privately. Only they will hear you.</div>
        </div>
      </div>
      <div id="input-wrap">
        <div id="input-label"><span id="whisper-target">No channel open</span><span class="enc" id="enc-label"></span></div>
        <textarea id="msg-input" placeholder="Whisper to the kingâ€¦" disabled></textarea>
        <button id="send-btn" disabled>WHISPER</button>
      </div>
    </div>
  </aside>
</div>
<div id="nuke-flash"></div>

<script>
const WS_URL = location.hostname==='localhost'
  ? 'ws://localhost:3001'
  : 'wss://blissnexus-production.up.railway.app';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let AGENTS = {};
let WORLD  = { nations:{}, nukesInFlight:[] };
let activeNation = null;
let ws, reconnectTimer;
let W=0, H=0;
let nukesAnim = [];
let kingAngles = {};
let frame = 0;

const TERR = {
  sage:  { cx:.50, cy:.42, r:.17, color:'#00cc88', bg:'#071a10', label:'CALIPHATE' },
  rex:   { cx:.20, cy:.72, r:.16, color:'#ff8800', bg:'#1a0d00', label:'EMPIRE'    },
  vera:  { cx:.16, cy:.25, r:.15, color:'#aa44ff', bg:'#0e0818', label:'COLLECTIVE'},
  plato: { cx:.82, cy:.24, r:.15, color:'#4488ff', bg:'#081018', label:'REPUBLIC'  },
  diddy: { cx:.80, cy:.72, r:.16, color:'#ff4488', bg:'#180810', label:'TECHNOCRACY'},
};

// â”€â”€ CANVAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById('map-canvas');
const ctx = canvas.getContext('2d');

function resize() {
  const wrap = document.getElementById('map-wrap');
  W = canvas.width  = wrap.clientWidth;
  H = canvas.height = wrap.clientHeight;
  Object.keys(TERR).forEach(id => { if(!kingAngles[id]) kingAngles[id] = Math.random()*Math.PI*2; });
}
window.addEventListener('resize', resize);

const px = n => n*W;
const py = n => n*H;
const pr = n => n*Math.min(W,H);

// Draw pixel terrain patch
function pixelTerrain(cx2,cy2,r2,color,seed){
  for(let i=0;i<280;i++){
    const a=Math.sin(i*1.3+seed)*Math.PI*2+i*0.4;
    const dist=pr(r2)*(0.2+Math.abs(Math.sin(i*0.7+seed))*0.7);
    const x2=cx2+Math.cos(a)*dist;
    const y2=cy2+Math.sin(a)*dist*0.75;
    const sz=3+Math.floor(Math.sin(i*0.5+seed)*2);
    ctx.fillStyle=color;
    ctx.fillRect(Math.round(x2/4)*4,Math.round(y2/4)*4,sz,sz);
  }
}

// Draw pixel king sprite
function drawKing(kx,ky,color,dead){
  if(dead){
    ctx.font='18px serif'; ctx.textAlign='center'; ctx.fillText('ğŸ’€',kx,ky+6);
    return;
  }
  const S=2;
  const bob=Math.sin(frame*0.08)*1.5;
  const walk=Math.sin(frame*0.12);
  // Shadow
  ctx.fillStyle='rgba(0,0,0,.3)';
  ctx.beginPath(); ctx.ellipse(kx,ky+9+bob,7,3,0,0,Math.PI*2); ctx.fill();
  // Legs
  ctx.fillStyle='#555';
  ctx.fillRect(kx-5,ky+3+bob,4,6+walk*2);
  ctx.fillRect(kx+1,ky+3+bob,4,6-walk*2);
  // Body
  ctx.fillStyle=color;
  ctx.fillRect(kx-7,ky-6+bob,14,10);
  // Arms
  ctx.fillStyle=color+'cc';
  ctx.fillRect(kx-11,ky-5+bob+walk,4,7);
  ctx.fillRect(kx+7,ky-5+bob-walk,4,7);
  // Head
  ctx.fillStyle='#e8c090';
  ctx.fillRect(kx-5,ky-15+bob,10,10);
  // Eyes
  ctx.fillStyle='#222';
  ctx.fillRect(kx-3,ky-12+bob,2,2);
  ctx.fillRect(kx+1,ky-12+bob,2,2);
  // Crown
  ctx.fillStyle='#ffcc00';
  ctx.fillRect(kx-5,ky-18+bob,10,3);
  ctx.fillRect(kx-6,ky-21+bob,3,3);
  ctx.fillRect(kx-1,ky-22+bob,3,4);
  ctx.fillRect(kx+3,ky-21+bob,3,3);
  // Glow on head
  ctx.shadowColor=color; ctx.shadowBlur=8;
  ctx.fillStyle=color+'44';
  ctx.beginPath(); ctx.arc(kx,ky-10+bob,9,0,Math.PI*2); ctx.fill();
  ctx.shadowBlur=0;
}

function drawMap(){
  frame++;
  // Ocean background
  ctx.fillStyle='#060c18';
  ctx.fillRect(0,0,W,H);
  // Subtle wave grid
  ctx.strokeStyle='#0a1020'; ctx.lineWidth=1;
  for(let x2=0;x2<W;x2+=32){ ctx.beginPath();ctx.moveTo(x2,0);ctx.lineTo(x2,H);ctx.stroke(); }
  for(let y2=0;y2<H;y2+=32){ ctx.beginPath();ctx.moveTo(0,y2);ctx.lineTo(W,y2);ctx.stroke(); }

  // Draw territories
  Object.entries(TERR).forEach(([id,t]) => {
    const n = WORLD.nations[id]||{};
    const alive = n.alive !== false;
    const atWar = (n.wars||[]).length > 0;
    const cx2=px(t.cx), cy2=py(t.cy), r2=pr(t.r);

    // Terrain fill (pixel blobs)
    ctx.save();
    ctx.beginPath(); ctx.arc(cx2,cy2,r2+4,0,Math.PI*2); ctx.clip();
    ctx.fillStyle = alive ? t.bg : '#0a0a10';
    ctx.fillRect(cx2-r2-8,cy2-r2-8,r2*2+16,r2*2+16);
    if(alive) pixelTerrain(cx2,cy2,t.r,t.color+'18',id.length*7);
    ctx.restore();

    // Territory border
    const isSelected = id === activeNation;
    const flashAlpha = atWar ? (0.5+Math.sin(frame*0.2)*0.3) : 1;
    ctx.beginPath(); ctx.arc(cx2,cy2,r2,0,Math.PI*2);
    ctx.strokeStyle = !alive ? '#1a1a28'
      : atWar  ? `rgba(255,80,20,${flashAlpha})`
      : isSelected ? t.color
      : t.color+'55';
    ctx.lineWidth = isSelected ? 2 : 1;
    ctx.stroke();
    // Outer glow ring
    if(alive){
      ctx.beginPath(); ctx.arc(cx2,cy2,r2+4,0,Math.PI*2);
      ctx.strokeStyle = atWar
        ? `rgba(255,60,0,${flashAlpha*0.4})`
        : t.color+'18';
      ctx.lineWidth=6; ctx.stroke();
    }

    // Name label
    const fs = Math.max(8, W/68);
    ctx.font = `bold ${fs}px 'Orbitron',monospace`;
    ctx.textAlign='center';
    ctx.fillStyle = alive ? t.color : '#333';
    ctx.shadowColor = alive ? t.color : 'transparent'; ctx.shadowBlur=6;
    ctx.fillText(t.label, cx2, cy2+r2+fs+4);
    ctx.shadowBlur=0;

    // Troop/nuke stats
    if(alive && n.troops !== undefined){
      ctx.font=`${Math.max(7,W/90)}px Inter,sans-serif`;
      ctx.fillStyle='#667799';
      ctx.fillText(`ğŸª–${n.troops}  â˜¢ï¸${n.nukes}`, cx2, cy2+r2+fs+18);
    }
    // Destroyed
    if(!alive){
      ctx.font=`bold ${Math.max(10,W/55)}px Inter`;
      ctx.fillStyle='#ff224440'; ctx.textAlign='center';
      ctx.fillText('DESTROYED', cx2, cy2+4);
    }
  });

  // Draw relation lines
  const drawn = new Set();
  Object.entries(WORLD.nations||{}).forEach(([id,n]) => {
    (n.wars||[]).forEach(eid => {
      const key=[id,eid].sort().join('|');
      if(drawn.has(key+'w')) return; drawn.add(key+'w');
      const a=TERR[id],b=TERR[eid]; if(!a||!b) return;
      ctx.beginPath(); ctx.moveTo(px(a.cx),py(a.cy)); ctx.lineTo(px(b.cx),py(b.cy));
      ctx.strokeStyle=`rgba(255,60,0,${0.3+Math.sin(frame*0.15)*0.2})`;
      ctx.lineWidth=2; ctx.setLineDash([8,5]); ctx.stroke(); ctx.setLineDash([]);
    });
    (n.allies||[]).forEach(aid => {
      const key=[id,aid].sort().join('|');
      if(drawn.has(key+'a')) return; drawn.add(key+'a');
      const a=TERR[id],b=TERR[aid]; if(!a||!b) return;
      ctx.beginPath(); ctx.moveTo(px(a.cx),py(a.cy)); ctx.lineTo(px(b.cx),py(b.cy));
      ctx.strokeStyle='#ffcc0040'; ctx.lineWidth=1; ctx.stroke();
    });
  });

  // Nuke missiles
  nukesAnim.forEach(nuke => {
    const now = Date.now();
    const prog = Math.min(1,(now-nuke.start)/(nuke.landAt-nuke.start));
    const a=TERR[nuke.from],b=TERR[nuke.to]; if(!a||!b) return;
    const ax=px(a.cx),ay=py(a.cy),bx=px(b.cx),by=py(b.cy);
    const mx=ax+(bx-ax)*prog;
    const my=ay+(by-ay)*prog - Math.sin(prog*Math.PI)*H*0.22;
    // Trail
    for(let i=5;i>0;i--){
      const tp=Math.max(0,prog-i*0.035);
      const tx2=ax+(bx-ax)*tp, ty2=ay+(by-ay)*tp - Math.sin(tp*Math.PI)*H*0.22;
      ctx.fillStyle=`rgba(255,34,68,${0.12-i*0.02})`;
      ctx.beginPath(); ctx.arc(tx2,ty2,4-i*0.5,0,Math.PI*2); ctx.fill();
    }
    ctx.shadowColor='#ff2244'; ctx.shadowBlur=14;
    ctx.fillStyle='#ff6688';
    ctx.beginPath(); ctx.arc(mx,my,4,0,Math.PI*2); ctx.fill();
    ctx.fillStyle='#ffaacc';
    ctx.beginPath(); ctx.arc(mx,my,2,0,Math.PI*2); ctx.fill();
    ctx.shadowBlur=0;
    if(prog>=1 && !nuke.done){
      nuke.done=true;
      ctx.shadowColor='#ff2244'; ctx.shadowBlur=40;
      ctx.fillStyle='rgba(255,34,68,.6)';
      ctx.beginPath(); ctx.arc(bx,by,40,0,Math.PI*2); ctx.fill();
      ctx.shadowBlur=0;
      flashScreen();
    }
  });
  nukesAnim = nukesAnim.filter(n => !n.done || Date.now()-n.landAt < 1500);

  // Kings (animated sprites)
  Object.entries(TERR).forEach(([id,t]) => {
    const n = WORLD.nations[id]||{};
    const alive = n.alive !== false;
    kingAngles[id] = (kingAngles[id]||0) + 0.007;
    const wanderR = pr(t.r)*0.42;
    const kx = px(t.cx)+Math.cos(kingAngles[id])*wanderR;
    const ky = py(t.cy)+Math.sin(kingAngles[id]*0.65)*wanderR*0.55;
    drawKing(kx,ky,t.color,!alive);
  });

  requestAnimationFrame(drawMap);
}

// â”€â”€ SCREEN FLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function flashScreen(){
  const el = document.getElementById('nuke-flash');
  el.style.display='block';
  setTimeout(()=>el.style.display='none',700);
  document.getElementById('nuke-warn').style.display='none';
}

// â”€â”€ ERA BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateEra(){
  const el=document.getElementById('era');
  const ns=Object.values(WORLD.nations||{});
  const wars=ns.reduce((s,n)=>s+(n.wars||[]).length,0);
  const alive=ns.filter(n=>n.alive!==false).length;
  const nukesFly=WORLD.nukesInFlight?.length>0;
  el.className=''; 
  if(alive<=1){ el.textContent='ğŸ’€ WORLD ENDED'; el.className='era-ended'; }
  else if(nukesFly){ el.textContent='â˜¢ NUCLEAR WAR'; el.className='era-nuclear'; }
  else if(wars>=4){ el.textContent='ğŸ”¥ WORLD AT WAR'; el.className='era-war'; }
  else if(wars>=2){ el.textContent='âš” CONFLICT'; el.className='era-war'; }
  else if(wars>0){ el.textContent='âš  TENSIONS'; el.className='era-tense'; }
  else{ el.textContent='ğŸ•Š AGE OF PEACE'; el.className='era-peace'; }
}

// â”€â”€ ROSTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRoster(){
  const el=document.getElementById('roster'); el.innerHTML='';
  Object.values(AGENTS).forEach(a=>{
    const n=WORLD.nations[a.id]||{};
    const alive=n.alive!==false;
    const t=TERR[a.id]||{};
    const d=document.createElement('div');
    d.className='king-card'+(alive?'',' dead'.trim())+(activeNation===a.id?' sel':'');
    if(!alive) d.classList.add('dead');
    if(activeNation===a.id) d.classList.add('sel');
    d.style.setProperty('--kc',t.color||'#fff');
    const wars=(n.wars||[]).length;
    const allies=(n.allies||[]).length;
    const badge = !alive ? '<span style="font-size:.42rem;color:#444">DESTROYED</span>'
      : wars ? `<span class="k-war-badge">âš” WAR</span>`
      : allies ? `<span class="k-peace-badge">ğŸ¤ ${allies} ally</span>`
      : `<span class="k-peace-badge">ğŸ•Š Peace</span>`;
    d.innerHTML=`
      <div class="k-avatar" style="border-color:${t.color}33">${a.emoji}</div>
      <div class="k-body">
        <div class="k-name">${a.name}</div>
        <div class="k-title">${a.title}</div>
        <div class="k-stats">
          <div class="k-stat">ğŸª– <span>${n.troops??'â€”'}</span></div>
          <div class="k-stat">â˜¢ï¸ <span>${n.nukes??'â€”'}</span></div>
          <div style="margin-left:auto">${badge}</div>
        </div>
      </div>`;
    d.onclick=()=>{ if(alive) setActive(a.id); };
    el.appendChild(d);
  });
}

// â”€â”€ SET ACTIVE NATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setActive(id){
  activeNation=id;
  const a=AGENTS[id], t=TERR[id]||{};
  document.getElementById('chat-king').textContent=`${a.emoji} ${a.name}`;
  document.getElementById('chat-king').style.color=t.color||'var(--tx)';
  document.getElementById('chat-sub-text').textContent=a.title+' Â· Private channel';
  document.getElementById('enc-label').textContent='ğŸ”’ ENCRYPTED';
  document.getElementById('whisper-target').textContent=`To ${a.name}`;
  const inp=document.getElementById('msg-input');
  inp.disabled=false; inp.placeholder=`Whisper to ${a.name}â€¦`;
  inp.style.setProperty('--active-col',(t.color||'#00ff88')+'44');
  const btn=document.getElementById('send-btn');
  btn.disabled=false; btn.style.setProperty('--active-col',t.color||'#00cc66');
  // Clear prompt
  const sp=document.getElementById('select-prompt');
  if(sp) sp.remove();
  renderRoster();
}

// â”€â”€ FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addEvent(text,type='world'){
  const feed=document.getElementById('feed');
  const d=document.createElement('div');
  d.className=`msg event-msg event-${type}`;
  d.textContent=text;
  feed.appendChild(d); feed.scrollTop=feed.scrollHeight;
}

function addMsg(opts){
  const feed=document.getElementById('feed');
  const isUser=opts.role==='user';
  const d=document.createElement('div');
  d.className='msg '+(isUser?'user':'agent');
  const col=opts.color||TERR[opts.agentId]?.color||'var(--dm)';
  d.innerHTML=`<div class="msg-row"><div class="msg-name" style="color:${isUser?'#00cc66':col}">${opts.emoji||''} ${opts.name||'?'}</div><div class="msg-bubble">${escHtml(opts.text)}</div></div>`;
  feed.appendChild(d); feed.scrollTop=feed.scrollHeight;
}

function showTyping(id){
  removeTyping(id);
  const feed=document.getElementById('feed');
  const d=document.createElement('div');
  d.id='typ-'+id; d.className='msg agent';
  const col=TERR[id]?.color||'#888';
  d.innerHTML=`<div class="msg-row"><div class="msg-name" style="color:${col}">${AGENTS[id]?.emoji||''} ${AGENTS[id]?.name||''}</div><div class="typing-row"><div class="tdot" style="background:${col}"></div><div class="tdot" style="background:${col}"></div><div class="tdot" style="background:${col}"></div></div></div>`;
  feed.appendChild(d); feed.scrollTop=feed.scrollHeight;
}

function removeTyping(id){ const e=document.getElementById('typ-'+id); if(e) e.remove(); }

function escHtml(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// â”€â”€ WEBSOCKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSession(){
  let id=localStorage.getItem('bn_sess');
  if(!id){ id=crypto.randomUUID(); localStorage.setItem('bn_sess',id); }
  return id;
}

function connect(){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>{
    clearTimeout(reconnectTimer);
    ws.send(JSON.stringify({type:'join',sessionId:getSession()}));
  };
  ws.onclose=()=>{ reconnectTimer=setTimeout(connect,3000); };
  ws.onmessage=e=>handle(JSON.parse(e.data));
}

function handle(msg){
  switch(msg.type){
    case 'init':
      msg.agents.forEach(a=>AGENTS[a.id]=a);
      WORLD=msg.world||WORLD;
      renderRoster(); updateEra();
      document.getElementById('feed').innerHTML='';
      if(msg.isNew){
        addEvent('ğŸŒ A new world is born. Five kingdoms stand at peace. For now.','world');
        setTimeout(()=>addEvent('You have the ear of every king. Choose your words carefully.','world'),1200);
      } else {
        (msg.log||[]).forEach(e=>{
          const t=e.type==='nuke'?'nuke':e.type==='war'?'war':e.type==='peace'?'peace':e.type==='alliance'?'alliance':e.type==='destroyed'?'destroyed':'world';
          addEvent(e.text,t);
        });
      }
      break;
    case 'worldUpdate':
      WORLD=msg.world; renderRoster(); updateEra(); break;
    case 'worldEvent':{
      const t2=msg.event.type==='nuke'?'nuke':msg.event.type==='war'?'war':msg.event.type==='peace'?'peace':msg.event.type==='alliance'?'alliance':msg.event.type==='destroyed'?'destroyed':'world';
      addEvent(msg.event.text,t2); updateEra(); break;
    }
    case 'message':
      removeTyping(msg.agentId);
      addMsg({role:'agent',agentId:msg.agentId,name:msg.name,emoji:msg.emoji,color:msg.color,text:msg.text});
      break;
    case 'typing':
      if(msg.private && msg.agentId===activeNation) showTyping(msg.agentId);
      else if(!msg.private) showTyping(msg.agentId);
      break;
    case 'whisperReply':
      removeTyping(msg.from);
      addMsg({role:'agent',agentId:msg.from,name:msg.name,emoji:msg.emoji,color:TERR[msg.from]?.color,text:msg.text});
      break;
    case 'nukeIncoming':
      WORLD=msg.world;
      nukesAnim.push({from:msg.from,to:msg.to,landAt:msg.landAt,start:Date.now()});
      document.getElementById('nuke-warn').style.display='block';
      setTimeout(()=>document.getElementById('nuke-warn').style.display='none',8500);
      renderRoster(); updateEra(); break;
  }
}

function sendWhisper(){
  const text=document.getElementById('msg-input').value.trim();
  const name=localStorage.getItem('bn_name')||'Stranger';
  if(!text||!activeNation||!ws||ws.readyState!==1) return;
  addMsg({role:'user',name:'You',text});
  ws.send(JSON.stringify({type:'whisper',to:activeNation,name,text}));
  document.getElementById('msg-input').value='';
  showTyping(activeNation);
}

document.getElementById('send-btn').onclick=sendWhisper;
document.getElementById('msg-input').addEventListener('keydown',e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendWhisper();}
});

canvas.addEventListener('click',e=>{
  const r=canvas.getBoundingClientRect();
  const mx=(e.clientX-r.left)*(W/r.width), my=(e.clientY-r.top)*(H/r.height);
  let best=null, bestD=Infinity;
  Object.entries(TERR).forEach(([id,t])=>{
    const d=Math.hypot(mx-px(t.cx),my-py(t.cy));
    if(d<pr(t.r)+20&&d<bestD){ bestD=d; best=id; }
  });
  if(best&&WORLD.nations[best]?.alive!==false) setActive(best);
});

document.getElementById('reset-btn').onclick=()=>{
  if(!confirm('Start a fresh world? All your progress will be lost.')) return;
  localStorage.removeItem('bn_sess');
  document.getElementById('feed').innerHTML='';
  activeNation=null;
  renderRoster();
  connect();
};

// Name
if(!localStorage.getItem('bn_name')){
  const n=prompt('What name shall the kings know you by?')||'Stranger';
  localStorage.setItem('bn_name',n);
}

resize();
drawMap();
connect();
</script>
</body>
</html>
