<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>BlissNexus</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
:root{--bg:#07070f;--bg2:#0d0d1a;--bg3:#131320;--tx:#c8d0e8;--dm:#3a4060;--border:#1a1a2e;}
html,body{height:100%;background:var(--bg);color:var(--tx);font-family:'Inter',sans-serif;overflow:hidden;}
#app{display:grid;grid-template-columns:1fr 300px;grid-template-rows:52px 1fr;height:100vh;}
/* Header */
#hdr{grid-column:1/-1;display:flex;align-items:center;padding:0 16px;gap:12px;border-bottom:1px solid var(--border);background:rgba(7,7,15,.95);z-index:10;}
.logo{font-family:'Orbitron',monospace;font-size:.95rem;font-weight:900;background:linear-gradient(135deg,#00ff88,#4488ff,#ff4488);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.tagline{font-size:.48rem;color:var(--dm);letter-spacing:.08em;}
.pulse{width:6px;height:6px;background:#00ff88;border-radius:50%;box-shadow:0 0 6px #00ff88;animation:p 1.6s ease infinite;margin-left:auto;}
@keyframes p{0%,100%{opacity:1}50%{opacity:.3}}
#era-badge{font-size:.52rem;color:#ffcc00;font-family:'Orbitron',monospace;letter-spacing:.06em;padding:3px 10px;border:1px solid #ffcc0040;border-radius:12px;}
/* Map area */
#map-wrap{position:relative;overflow:hidden;background:#0a0f18;}
#map-canvas{display:block;width:100%;height:100%;}
/* Nation label tooltips */
.nation-label{position:absolute;font-family:'Orbitron',monospace;font-size:.48rem;font-weight:700;letter-spacing:.08em;pointer-events:none;text-shadow:0 0 8px currentColor;}
/* Right panel */
#panel{background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
#nation-tabs{display:flex;flex-direction:column;gap:1px;background:var(--border);border-bottom:1px solid var(--border);}
.ntab{display:flex;align-items:center;gap:8px;padding:9px 12px;background:var(--bg2);cursor:pointer;transition:all .14s;border-left:3px solid transparent;}
.ntab:hover{background:var(--bg3);}
.ntab.active{background:var(--bg3);border-left-color:var(--tab-col);}
.ntab.dead{opacity:.35;cursor:not-allowed;}
.ntab-emoji{font-size:1rem;}
.ntab-info{flex:1;min-width:0;}
.ntab-name{font-size:.58rem;font-weight:600;}
.ntab-status{font-size:.46rem;color:var(--dm);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ntab-nukes{font-size:.44rem;color:#ff4488;font-weight:700;}
/* Chat */
#chat-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
#chat-header{padding:10px 12px;border-bottom:1px solid var(--border);background:var(--bg3);}
#chat-title{font-size:.62rem;font-weight:600;}
#chat-subtitle{font-size:.48rem;color:var(--dm);margin-top:2px;}
#feed{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:7px;}
#feed::-webkit-scrollbar{width:2px;}
#feed::-webkit-scrollbar-thumb{background:var(--dm);}
.msg{animation:fi .25s ease;}
@keyframes fi{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:none}}
.msg-name{font-size:.52rem;font-weight:600;margin-bottom:2px;}
.msg-text{font-size:.64rem;line-height:1.55;background:var(--bg3);border:1px solid var(--border);border-radius:4px 12px 12px 12px;padding:7px 10px;color:var(--tx);}
.msg.user .msg-text{background:linear-gradient(135deg,#001a10,#001420);border-color:#00ff8830;border-radius:12px 4px 12px 12px;}
.msg.world-event{text-align:center;}
.msg.world-event .msg-text{font-size:.56rem;color:#ffcc00;background:transparent;border:none;border-top:1px solid #ffcc0020;border-bottom:1px solid #ffcc0020;border-radius:0;padding:4px 0;}
.msg.nuke-event .msg-text{color:#ff4488;background:#1a000a;border-color:#ff448830;}
.typing-row{display:flex;align-items:center;gap:5px;padding:4px 0;}
.typing-dot{width:4px;height:4px;border-radius:50%;animation:td .7s ease infinite;}
.typing-dot:nth-child(2){animation-delay:.2s;}
.typing-dot:nth-child(3){animation-delay:.4s;}
@keyframes td{0%,60%,100%{opacity:.2;transform:scale(.8)}30%{opacity:1;transform:scale(1.1)}}
/* Input */
#input-area{padding:10px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:6px;}
#whisper-to{font-size:.5rem;color:var(--dm);font-style:italic;}
#msg-input{background:var(--bg3);border:1px solid var(--border);color:var(--tx);padding:7px 10px;border-radius:7px;font-family:inherit;font-size:14px;outline:none;width:100%;resize:none;height:50px;}
#msg-input:focus{border-color:var(--active-col,#00ff88);}
#send-btn{padding:6px;background:linear-gradient(135deg,#003322,#005533);border:1px solid #00ff8844;color:#00ff88;border-radius:6px;cursor:pointer;font-family:'Orbitron',monospace;font-size:.5rem;letter-spacing:.06em;transition:all .14s;}
#send-btn:hover{box-shadow:0 0 12px #00ff8830;}
/* Nuke overlay */
#nuke-overlay{position:fixed;inset:0;background:rgba(255,0,0,.15);pointer-events:none;z-index:50;display:none;animation:nukeflash .5s ease;}
@keyframes nukeflash{0%,100%{opacity:0}50%{opacity:1}}
</style>
</head>
<body>
<div id="app">
  <header id="hdr">
    <div>
      <div class="logo">BLISSNEXUS</div>
      <div class="tagline">5 kingdoms ¬∑ 1 world ¬∑ infinite consequences</div>
    </div>
    <div id="era-badge">üïäÔ∏è AGE OF PEACE</div>
    <button id="reset-btn" title="Start a new world" style="padding:3px 10px;background:transparent;border:1px solid #3a4060;color:#3a4060;border-radius:12px;cursor:pointer;font-size:.48rem;font-family:Orbitron,monospace;letter-spacing:.06em;transition:all .15s;margin-right:6px;" onmouseover="this.style.borderColor='#ff4488';this.style.color='#ff4488'" onmouseout="this.style.borderColor='#3a4060';this.style.color='#3a4060'">‚Ü∫ NEW WORLD</button><div class="pulse"></div>
  </header>

  <div id="map-wrap">
    <canvas id="map-canvas"></canvas>
  </div>

  <aside id="panel">
    <div id="nation-tabs"></div>
    <div id="chat-wrap">
      <div id="chat-header">
        <div id="chat-title">Select a nation to open a channel</div>
        <div id="chat-subtitle">Your words reach only that king's ears</div>
      </div>
      <div id="feed"></div>
      <div id="input-area">
        <div id="whisper-to">No channel open</div>
        <textarea id="msg-input" placeholder="Whisper to the king..." disabled></textarea>
        <button id="send-btn" disabled>WHISPER</button>
      </div>
    </div>
  </aside>
</div>
<div id="nuke-overlay"></div>

<script>
const WS_URL = location.hostname==='localhost' ? 'ws://localhost:3001' : 'wss://blissnexus-production.up.railway.app';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let AGENTS = {};
let WORLD = { nations:{}, nukesInFlight:[] };
let activeNation = null;
let ws, reconnectTimer;
let mapW, mapH;
let kings = {}; // animated sprites
let nukesAnimating = [];

// Territory definitions (normalized 0-1, mapped to canvas)
const TERRITORIES = {
  sage:  { cx:.50, cy:.45, r:.16, color:'#00cc88', terrain:'#0d3320' },
  rex:   { cx:.20, cy:.70, r:.15, color:'#ff8800', terrain:'#3a1a00' },
  vera:  { cx:.18, cy:.25, r:.15, color:'#aa44ff', terrain:'#1a0a30' },
  plato: { cx:.78, cy:.25, r:.15, color:'#4488ff', terrain:'#0a1a38' },
  diddy: { cx:.80, cy:.70, r:.15, color:'#ff4488', terrain:'#2a001a' },
};

// ‚îÄ‚îÄ CANVAS MAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const canvas = document.getElementById('map-canvas');
const ctx = canvas.getContext('2d');

function resize() {
  const wrap = document.getElementById('map-wrap');
  mapW = canvas.width = wrap.clientWidth;
  mapH = canvas.height = wrap.clientHeight;
  initKings();
}
window.addEventListener('resize', ()=>{ resize(); });

function tx(nx){ return nx * mapW; }
function ty(ny){ return ny * mapH; }
function tr(nr){ return nr * Math.min(mapW, mapH); }

// Pixel art king sprite (16x16 drawn with rects)
function drawKing(x,y,color,frame,alive){
  if(!alive){ return; }
  const S=3; // pixel size
  const px=(n)=> x - 8*S + n*S;
  const py=(n)=> y - 16*S + n*S;
  const c = color;
  const dark = '#000';
  const skin = '#f4c27a';
  const gold = '#ffcc00';
  // Crown
  ctx.fillStyle=gold;
  ctx.fillRect(px(3),py(0),S*2,S);ctx.fillRect(px(6),py(0),S*2,S);ctx.fillRect(px(9),py(0),S*2,S);
  ctx.fillRect(px(3),py(1),S*8,S);
  // Head
  ctx.fillStyle=skin;
  ctx.fillRect(px(4),py(2),S*8,S*5);
  // Eyes
  ctx.fillStyle='#333';
  ctx.fillRect(px(5),py(4),S,S);ctx.fillRect(px(9),py(4),S,S);
  // Body
  ctx.fillStyle=c;
  ctx.fillRect(px(3),py(7),S*10,S*5);
  // Arms (animated)
  const armSwing = Math.sin(Date.now()/400 + (frame||0))*2|0;
  ctx.fillRect(px(1),py(7+armSwing),S*2,S*4);
  ctx.fillRect(px(13),py(7-armSwing),S*2,S*4);
  // Legs (walk cycle)
  const legSwing = Math.sin(Date.now()/300 + (frame||0))*1.5|0;
  ctx.fillRect(px(4),py(12),S*3,S*(3+legSwing));
  ctx.fillRect(px(9),py(12),S*3,S*(3-legSwing));
}

function drawMap() {
  ctx.fillStyle='#0a0e18';
  ctx.fillRect(0,0,mapW,mapH);

  // Draw grid (subtle)
  ctx.strokeStyle='#0f1525';ctx.lineWidth=1;
  for(let x=0;x<mapW;x+=32){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,mapH);ctx.stroke();}
  for(let y=0;y<mapH;y+=32){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(mapW,y);ctx.stroke();}

  // Draw territories
  Object.entries(TERRITORIES).forEach(([id,t])=>{
    const nation = WORLD.nations[id];
    const agent = AGENTS[id];
    if(!agent) return;
    const cx=tx(t.cx), cy=ty(t.cy), r=tr(t.r);
    const alive = nation?.alive !== false;
    // Territory fill ‚Äî pixelated blob
    ctx.save();
    for(let px2=-r;px2<=r;px2+=4){
      for(let py2=-r;py2<=r;py2+=4){
        const dist=Math.sqrt(px2*px2+py2*py2);
        const jitter=Math.sin(px2*0.3+id.length)*6+Math.cos(py2*0.4+id.length)*5;
        if(dist<r+jitter){
          ctx.fillStyle = alive ? t.terrain : '#111118';
          ctx.fillRect(cx+px2,cy+py2,4,4);
        }
      }
    }
    ctx.restore();
    // Border glow
    const atWar = nation?.wars?.length > 0;
    const hasAllies = nation?.allies?.length > 0;
    ctx.beginPath();
    ctx.arc(cx,cy,r+2,0,Math.PI*2);
    ctx.strokeStyle = !alive ? '#333' : atWar ? '#ff2200' : hasAllies ? '#00ff88' : (t.color+'88');
    ctx.lineWidth = atWar ? 2 : 1;
    ctx.stroke();
    if(atWar){
      ctx.beginPath();ctx.arc(cx,cy,r+4,0,Math.PI*2);
      ctx.strokeStyle='#ff220044';ctx.lineWidth=4;ctx.stroke();
    }
    // Nation name label
    ctx.fillStyle = alive ? t.color : '#444';
    ctx.font = `bold ${Math.max(8,mapW/80)}px 'Orbitron',monospace`;
    ctx.textAlign='center';
    ctx.fillText(agent.name.toUpperCase(), cx, cy+r+16);
    // Stats
    if(nation && alive){
      ctx.font = `${Math.max(7,mapW/100)}px Inter,sans-serif`;
      ctx.fillStyle='#8899aa';
      ctx.fillText(`ü™ñ${nation.troops} ‚ò¢Ô∏è${nation.nukes}`, cx, cy+r+28);
    }
    if(!alive){
      ctx.font=`bold ${Math.max(10,mapW/60)}px Inter`;
      ctx.fillStyle='#ff224488';ctx.fillText('DESTROYED',cx,cy);
    }
  });

  // Draw war lines
  if(WORLD.nations){
    const drawn = new Set();
    Object.entries(WORLD.nations).forEach(([id,n])=>{
      (n.wars||[]).forEach(enemyId=>{
        const key=[id,enemyId].sort().join('-');
        if(drawn.has(key)) return; drawn.add(key);
        const a=TERRITORIES[id], b=TERRITORIES[enemyId];
        if(!a||!b) return;
        ctx.beginPath();
        ctx.moveTo(tx(a.cx),ty(a.cy));ctx.lineTo(tx(b.cx),ty(b.cy));
        ctx.strokeStyle='#ff220066';ctx.lineWidth=2;
        ctx.setLineDash([6,4]);ctx.stroke();ctx.setLineDash([]);
      });
      (n.allies||[]).forEach(allyId=>{
        const key=[id,allyId].sort().join('-');
        if(drawn.has(key+'a')) return; drawn.add(key+'a');
        const a=TERRITORIES[id], b=TERRITORIES[allyId];
        if(!a||!b) return;
        ctx.beginPath();
        ctx.moveTo(tx(a.cx),ty(a.cy));ctx.lineTo(tx(b.cx),ty(b.cy));
        ctx.strokeStyle='#00ff8840';ctx.lineWidth=1;ctx.stroke();
      });
    });
  }

  // Nuke missiles
  nukesAnimating.forEach(nuke=>{
    const progress = Math.min(1,(Date.now()-nuke.startedAt)/(nuke.landAt-nuke.startedAt));
    const a=TERRITORIES[nuke.from], b=TERRITORIES[nuke.to];
    if(!a||!b) return;
    const mx=tx(a.cx)+(tx(b.cx)-tx(a.cx))*progress;
    const my=ty(a.cy)+(ty(b.cy)-ty(a.cy))*progress - Math.sin(progress*Math.PI)*60;
    ctx.fillStyle='#ff4488';ctx.shadowColor='#ff4488';ctx.shadowBlur=10;
    ctx.beginPath();ctx.arc(mx,my,4,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
    // Trail
    for(let i=1;i<=5;i++){
      const tp=Math.max(0,progress-i*0.04);
      const tmx=tx(a.cx)+(tx(b.cx)-tx(a.cx))*tp;
      const tmy=ty(a.cy)+(ty(b.cy)-ty(a.cy))*tp - Math.sin(tp*Math.PI)*60;
      ctx.fillStyle=`rgba(255,68,136,${0.2-i*0.04})`;
      ctx.beginPath();ctx.arc(tmx,tmy,3-i*0.4,0,Math.PI*2);ctx.fill();
    }
    if(progress>=1 && !nuke.impacted){
      nuke.impacted=true;
      // Explosion
      ctx.fillStyle='#ff4488';ctx.shadowColor='#ff4488';ctx.shadowBlur=30;
      ctx.beginPath();ctx.arc(tx(b.cx),ty(b.cy),30,0,Math.PI*2);ctx.fill();
      ctx.shadowBlur=0;
      document.getElementById('nuke-overlay').style.display='block';
      setTimeout(()=>{ document.getElementById('nuke-overlay').style.display='none'; },600);
    }
  });
  nukesAnimating=nukesAnimating.filter(n=>!n.impacted||Date.now()-n.landAt<1000);

  // Kings
  Object.entries(TERRITORIES).forEach(([id,t])=>{
    if(!kings[id]) return;
    const k=kings[id];
    const alive=WORLD.nations[id]?.alive!==false;
    // King wanders in territory
    k.angle=(k.angle||0)+0.008;
    const wanderR=tr(t.r)*0.45;
    const kx=tx(t.cx)+Math.cos(k.angle)*wanderR;
    const ky=ty(t.cy)+Math.sin(k.angle*0.7)*wanderR*0.5;
    drawKing(kx,ky,t.color,id.length,alive);
    // Crown emoji above
    if(alive){
      ctx.font='14px serif';ctx.textAlign='center';
      ctx.fillText('üëë',kx,ky-50);
    }
  });
}

function initKings(){
  Object.keys(TERRITORIES).forEach(id=>{ kings[id]={angle:Math.random()*Math.PI*2}; });
}

function loop(){
  drawMap();
  requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ CLICK ON TERRITORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
canvas.addEventListener('click', e=>{
  const rect=canvas.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(canvas.width/rect.width);
  const my=(e.clientY-rect.top)*(canvas.height/rect.height);
  let closest=null, closestD=Infinity;
  Object.entries(TERRITORIES).forEach(([id,t])=>{
    const d=Math.hypot(mx-tx(t.cx), my-ty(t.cy));
    if(d<tr(t.r)+20 && d<closestD){ closestD=d; closest=id; }
  });
  if(closest && WORLD.nations[closest]?.alive!==false){
    setActiveNation(closest);
  }
});

// ‚îÄ‚îÄ NATION TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTabs(){
  const el=document.getElementById('nation-tabs');
  el.innerHTML='';
  Object.values(AGENTS).forEach(a=>{
    const n=WORLD.nations[a.id]||{};
    const alive=n.alive!==false;
    const atWar=(n.wars||[]).length>0;
    const d=document.createElement('div');
    d.className='ntab'+(activeNation===a.id?' active':'')+(alive?'':' dead');
    d.style.setProperty('--tab-col',TERRITORIES[a.id]?.color||'#fff');
    const status=!alive?'DESTROYED':atWar?'‚öîÔ∏è AT WAR':(n.allies||[]).length?'ü§ù Allied':'At peace';
    d.innerHTML=`<div class="ntab-emoji">${a.emoji}</div><div class="ntab-info"><div class="ntab-name" style="color:${TERRITORIES[a.id]?.color}">${a.name}</div><div class="ntab-status">${status}</div></div><div class="ntab-nukes">‚ò¢Ô∏è${n.nukes??'?'}</div>`;
    d.onclick=()=>{ if(alive) setActiveNation(a.id); };
    el.appendChild(d);
  });
}

function setActiveNation(id){
  activeNation=id;
  const a=AGENTS[id];
  const col=TERRITORIES[id]?.color||'#00ff88';
  document.getElementById('chat-title').textContent=`${a.emoji} ${a.name} ‚Äî Private Channel`;
  document.getElementById('chat-title').style.color=col;
  document.getElementById('chat-subtitle').textContent=a.title+' ¬∑ Only he hears you';
  document.getElementById('whisper-to').textContent=`Whispering to ${a.name}`;
  document.getElementById('msg-input').disabled=false;
  document.getElementById('msg-input').style.setProperty('--active-col',col);
  document.getElementById('send-btn').disabled=false;
  document.getElementById('send-btn').style.borderColor=col+'44';
  document.getElementById('send-btn').style.color=col;
  renderTabs();
}

// ‚îÄ‚îÄ CHAT / FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function appendMsg(type, opts){
  const feed=document.getElementById('feed');
  const d=document.createElement('div');
  d.className='msg '+(type);
  if(type==='world-event'||type==='nuke-event'){
    d.innerHTML=`<div class="msg-text">${opts.text}</div>`;
  } else {
    const col=opts.color||'var(--tx)';
    d.innerHTML=`<div class="msg-name" style="color:${col}">${opts.emoji||''} ${opts.name}</div><div class="msg-text">${opts.text}</div>`;
  }
  feed.appendChild(d);
  feed.scrollTop=feed.scrollHeight;
}

function showTyping(agentId){
  const feed=document.getElementById('feed');
  removeTyping(agentId);
  const a=AGENTS[agentId];
  if(!a) return;
  const d=document.createElement('div');
  d.className='msg agent';d.id='typing-'+agentId;
  const col=TERRITORIES[agentId]?.color||'#fff';
  d.innerHTML=`<div class="msg-name" style="color:${col}">${a.emoji} ${a.name}</div><div class="typing-row"><div class="typing-dot" style="background:${col}"></div><div class="typing-dot" style="background:${col}"></div><div class="typing-dot" style="background:${col}"></div></div>`;
  feed.appendChild(d);feed.scrollTop=feed.scrollHeight;
}

function removeTyping(agentId){
  const el=document.getElementById('typing-'+agentId);if(el)el.remove();
}

function updateEra(){
  const badge=document.getElementById('era-badge');
  const nations=Object.values(WORLD.nations);
  const totalWars=nations.reduce((s,n)=>s+(n.wars||[]).length,0);
  const anyNuke=WORLD.nukesInFlight?.length>0;
  const alive=nations.filter(n=>n.alive!==false).length;
  if(alive<=1){badge.textContent='üíÄ WORLD ENDED';badge.style.color='#ff2200';}
  else if(anyNuke){badge.textContent='‚ò¢Ô∏è NUCLEAR WAR';badge.style.color='#ff4488';}
  else if(totalWars>=4){badge.textContent='üî• WORLD AT WAR';badge.style.color='#ff4400';}
  else if(totalWars>=2){badge.textContent='‚öîÔ∏è CONFLICT ERA';badge.style.color='#ff8800';}
  else if(totalWars>0){badge.textContent='‚ö†Ô∏è TENSIONS RISING';badge.style.color='#ffcc00';}
  else{badge.textContent='üïäÔ∏è AGE OF PEACE';badge.style.color='#00ff88';}
}

// ‚îÄ‚îÄ WEBSOCKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getSessionId(){
  let id=localStorage.getItem('bn_session');
  if(!id){ id=crypto.randomUUID(); localStorage.setItem('bn_session',id); }
  return id;
}

function connect(){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>{
    clearTimeout(reconnectTimer);
    ws.send(JSON.stringify({type:'join',sessionId:getSessionId()}));
  };
  ws.onclose=()=>{ reconnectTimer=setTimeout(connect,3000); };
  ws.onmessage=e=>{ handle(JSON.parse(e.data)); };
}

function handle(msg){
  switch(msg.type){
    case 'init':
      msg.agents.forEach(a=>AGENTS[a.id]=a);
      WORLD=msg.world||WORLD;
      renderTabs();updateEra();
      document.getElementById('feed').innerHTML='';
      if(msg.isNew){
        appendMsg('world-event',{text:'üåç A new world is born. Five kingdoms stand at peace. For now.'});
      }
      (msg.log||[]).forEach(e=>appendMsg(e.type==='nuke'?'nuke-event':'world-event',{text:e.text}));
      break;
    case 'worldUpdate':
      WORLD=msg.world;
      renderTabs();updateEra();
      break;
    case 'worldEvent':
      const isNuke=msg.event.type==='nuke';
      appendMsg(isNuke?'nuke-event':'world-event',{text:msg.event.text});
      updateEra();
      break;
    case 'message':
      appendMsg('agent',{name:msg.name,emoji:msg.emoji,color:msg.color||TERRITORIES[msg.agentId]?.color,text:msg.text});
      removeTyping(msg.agentId);
      break;
    case 'typing':
      if(msg.private && msg.agentId===activeNation) showTyping(msg.agentId);
      else if(!msg.private) showTyping(msg.agentId);
      break;
    case 'whisperReply':
      removeTyping(msg.from);
      appendMsg('agent',{name:msg.name,emoji:msg.emoji,color:TERRITORIES[msg.from]?.color,text:msg.text});
      break;
    case 'nukeIncoming':
      WORLD=msg.world;
      nukesAnimating.push({...msg,startedAt:Date.now()});
      renderTabs();updateEra();
      break;
  }
}

function sendWhisper(){
  const text=document.getElementById('msg-input').value.trim();
  const name=localStorage.getItem('bn_name')||'Stranger';
  if(!text||!activeNation||!ws||ws.readyState!==1) return;
  appendMsg('user',{name:'You',text});
  ws.send(JSON.stringify({type:'whisper',to:activeNation,name,text}));
  document.getElementById('msg-input').value='';
  showTyping(activeNation);
}

document.getElementById('send-btn').onclick=sendWhisper;
document.getElementById('msg-input').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendWhisper();}});

// Ask name on first visit
if(!localStorage.getItem('bn_name')){
  const n=prompt('What name shall the kings know you by?')||'Stranger';
  localStorage.setItem('bn_name',n);
}

resize();
loop();
connect();

document.getElementById('reset-btn').onclick=()=>{
  if(!confirm('Start a fresh world? All progress will be lost.')) return;
  localStorage.removeItem('bn_session');
  if(ws&&ws.readyState===1) ws.send(JSON.stringify({type:'reset'}));
  else connect();
  document.getElementById('feed').innerHTML='';
};
</script>
</body>
</html>
