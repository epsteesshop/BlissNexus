<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>BlissNexus</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;900&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden;background:#0a0a12;color:#e8e0d0;font-family:'Roboto',sans-serif}
#header{position:fixed;top:0;left:0;right:0;height:50px;background:#0f0f1a;border-bottom:1px solid #2a2a3a;display:flex;align-items:center;padding:0 12px;gap:10px;z-index:100}
#logo{font-family:'Cinzel',serif;font-size:18px;font-weight:900;color:#c8a84b;white-space:nowrap}
#tension-wrap{display:flex;align-items:center;gap:6px;margin-left:8px}
#tension-bar-outer{width:80px;height:6px;background:#1a1a2a;border-radius:3px;overflow:hidden}
#tension-bar-inner{height:100%;width:10%;background:#2ecc71;border-radius:3px;transition:width 0.5s,background 0.5s}
#year-badge{font-size:11px;color:#888;white-space:nowrap}
#era-badge{font-size:10px;padding:2px 7px;border-radius:10px;background:#1a2a1a;color:#2ecc71;font-weight:500;white-space:nowrap}
#content{position:fixed;top:50px;left:0;right:0;bottom:58px;overflow:hidden}
.tab-page{display:none;position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch}
.tab-page.active{display:block}
#nav{position:fixed;bottom:0;left:0;right:0;height:58px;background:#0f0f1a;border-top:1px solid #2a2a3a;display:flex;z-index:100}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;background:none;border:none;color:#555;cursor:pointer;font-size:9px;font-weight:500;letter-spacing:0.5px;transition:color 0.2s}
.nav-btn.active{color:#c8a84b}
.nav-btn .nav-icon{font-size:20px}
.nav-badge{position:absolute;top:8px;right:calc(20% - 14px);background:#e74c3c;color:#fff;border-radius:8px;font-size:9px;padding:1px 4px;display:none}

/* Mission banner */
#mission-banner{position:fixed;bottom:58px;left:0;right:0;z-index:99;display:none;align-items:center;padding:8px 12px;gap:8px;font-size:12px}
#mission-banner .mb-emoji{font-size:20px}
#mission-banner .mb-text{flex:1;font-size:11px}
#mission-banner .mb-timer{font-size:11px;opacity:0.8;white-space:nowrap}
#mission-banner .mb-close{background:none;border:none;color:inherit;font-size:16px;cursor:pointer;opacity:0.7;padding:0 4px}

/* MAP tab */
#tab-map{background:#0a0a12}
#map-canvas{display:block;width:100%;height:100%}

/* KINGS tab */
#tab-kings{padding:10px;padding-bottom:20px}
.king-card{background:#0f0f1a;border-radius:10px;margin-bottom:12px;padding:12px;border-left:4px solid #555;cursor:pointer;position:relative}
.king-card-top{display:flex;align-items:flex-start;gap:10px;margin-bottom:8px}
.king-emoji-tile{font-size:36px;width:46px;height:46px;display:flex;align-items:center;justify-content:center;background:#1a1a2a;border-radius:8px;flex-shrink:0}
.king-info{flex:1;min-width:0}
.king-name{font-family:'Cinzel',serif;font-size:15px;font-weight:600}
.king-title{font-size:11px;color:#888;margin-top:1px}
.king-mood-row{display:flex;align-items:center;gap:6px;margin-top:4px;font-size:11px;color:#aaa}
.king-stats{display:flex;flex-wrap:wrap;gap:6px;margin:8px 0;font-size:12px}
.king-stat{background:#1a1a2a;padding:3px 8px;border-radius:6px}
.king-stat.fogged{opacity:0.6;color:#aaa}
.king-cities{margin:6px 0;font-size:11px;color:#888}
.king-cities span{margin-right:8px}
.king-cities .city-dead{text-decoration:line-through;opacity:0.5}
.king-ambition-wrap{margin:6px 0}
.king-ambition-label{font-size:10px;color:#888;margin-bottom:3px}
.king-ambition-bar{height:4px;background:#1a1a2a;border-radius:2px;overflow:hidden}
.king-ambition-fill{height:100%;border-radius:2px;transition:width 0.5s}
.king-relations{display:flex;flex-wrap:wrap;gap:5px;margin:6px 0}
.rel-badge{font-size:10px;padding:2px 6px;border-radius:8px;display:flex;align-items:center;gap:3px}
.rel-dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.king-trust-wrap{margin:6px 0}
.king-trust-label{font-size:10px;color:#888;margin-bottom:3px}
.trust-bar-outer{height:6px;background:#1a1a2a;border-radius:3px;overflow:hidden}
.trust-bar-inner{height:100%;border-radius:3px;transition:width 0.5s}
.king-pentagon-row{display:flex;align-items:center;gap:10px;margin:6px 0}
.pentagon-canvas{border-radius:4px;background:#0a0a12}
.dead-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.6);border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:32px}

/* WHISPER tab */
#tab-whisper{display:flex;flex-direction:column}
#whisper-header{background:#0f0f1a;padding:10px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid #1a1a2a;flex-shrink:0}
#whisper-back{background:none;border:none;color:#888;font-size:20px;cursor:pointer;padding:0 6px 0 0}
#whisper-king-info{flex:1}
#whisper-king-name{font-family:'Cinzel',serif;font-size:15px;font-weight:600}
#whisper-king-title{font-size:10px;color:#888}
#whisper-private-badge{font-size:10px;color:#888;background:#1a1a2a;padding:2px 7px;border-radius:8px}
#whisper-trust-badge{font-size:10px;padding:2px 7px;border-radius:8px;background:#1a2a1a}
#whisper-mission-bar{background:#1a1a12;padding:6px 12px;font-size:11px;color:#c8a84b;border-bottom:1px solid #2a2a1a;display:none;flex-shrink:0}
#whisper-feed{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px;display:flex;flex-direction:column;gap:8px}
#whisper-typing{padding:4px 12px;font-size:11px;color:#888;font-style:italic;min-height:20px;flex-shrink:0}
#whisper-input-wrap{display:flex;gap:8px;padding:8px 10px;background:#0f0f1a;border-top:1px solid #1a1a2a;flex-shrink:0}
#whisper-input{flex:1;background:#1a1a2a;border:none;border-radius:20px;padding:9px 14px;color:#e8e0d0;font-size:14px;outline:none}
#whisper-send{background:#c8a84b;border:none;border-radius:50%;width:38px;height:38px;font-size:18px;cursor:pointer;flex-shrink:0;display:flex;align-items:center;justify-content:center}
.msg-bubble{max-width:80%;padding:8px 12px;border-radius:16px;font-size:13px;line-height:1.4}
.msg-agent{align-self:flex-start;background:#1a1a2a;border-bottom-left-radius:4px}
.msg-user{align-self:flex-end;background:#2a1a2a;border-bottom-right-radius:4px}
.msg-event{align-self:center;font-size:11px;color:#888;font-style:italic;text-align:center;background:none;padding:4px}
.msg-name{font-size:10px;font-weight:500;margin-bottom:3px}

/* INTEL tab */
#tab-intel{padding:10px;padding-bottom:20px}
.intel-section{margin-bottom:16px}
.intel-title{font-size:11px;letter-spacing:2px;color:#888;text-transform:uppercase;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid #1a1a2a}
.intercept-entry{background:#0f0f1a;border:1px solid #1a2a0a;border-radius:6px;padding:8px 10px;margin-bottom:6px;font-family:monospace;font-size:11px;color:#c8a84b}
.intercept-header{color:#666;font-size:10px;margin-bottom:3px}
.intercept-text{color:#d4a843;font-style:italic}
.intercept-empty{color:#444;font-size:12px;font-style:italic;text-align:center;padding:20px}
.rel-matrix{width:100%;border-collapse:collapse;font-size:11px}
.rel-matrix th,.rel-matrix td{padding:5px;text-align:center;border:1px solid #1a1a2a}
.rel-matrix th{color:#888;background:#0a0a12;font-weight:400}
.rel-matrix .self-cell{background:#0f0f1a}
.rel-cell-ally{background:#1a2a1a;color:#2ecc71}
.rel-cell-friendly{background:#1a1a2a;color:#3498db}
.rel-cell-neutral{background:#0f0f1a;color:#888}
.rel-cell-rival{background:#2a1a1a;color:#e67e22}
.rel-cell-enemy{background:#2a0a0a;color:#e74c3c}

/* CHRONICLE tab */
#tab-chronicle{padding:16px;padding-bottom:30px}
.chronicle-empty{text-align:center;color:#555;padding:40px 20px;font-style:italic}
.chronicle-entry{background:#0f0a06;border:1px solid #2a1a06;border-radius:8px;padding:14px;margin-bottom:14px}
.chronicle-year{font-family:'Cinzel',serif;font-size:13px;color:#c8a84b;text-align:center;margin-bottom:8px;letter-spacing:2px}
.chronicle-text{font-size:13px;line-height:1.7;color:#c8b87a;font-style:italic}

/* Toast */
#toast-container{position:fixed;top:60px;left:50%;transform:translateX(-50%);z-index:200;display:flex;flex-direction:column;gap:6px;align-items:center;pointer-events:none}
.toast{background:#1a1a2a;border-radius:20px;padding:8px 16px;font-size:12px;color:#e8e0d0;box-shadow:0 4px 20px rgba(0,0,0,0.5);animation:toastIn 0.3s ease;max-width:280px;text-align:center}
.toast.war{border-left:3px solid #e74c3c;color:#ff6b6b}
.toast.nuke{border-left:3px solid #ff4400;color:#ff8844}
.toast.alliance{border-left:3px solid #2ecc71;color:#7dff9a}
.toast.peace{border-left:3px solid #3498db;color:#7ac8ff}
.toast.event{border-left:3px solid #f39c12;color:#f5c842}
.toast.year{border-left:3px solid #c8a84b;color:#c8a84b}
.toast.mission{border-left:3px solid #9b59b6;color:#c39bd3}
@keyframes toastIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}

/* Nuke overlay */
#nuke-overlay{position:fixed;inset:0;z-index:300;pointer-events:none;display:none}
#nuke-canvas{position:absolute;inset:0;width:100%;height:100%}
#nuke-flash{position:absolute;inset:0;background:#fff;opacity:0;transition:opacity 0.1s}

/* Name modal */
#name-modal{position:fixed;inset:0;z-index:400;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center}
#name-modal-box{background:#0f0f1a;border:1px solid #c8a84b;border-radius:16px;padding:30px 24px;width:280px;text-align:center}
#name-modal-title{font-family:'Cinzel',serif;font-size:20px;color:#c8a84b;margin-bottom:6px}
#name-modal-sub{font-size:12px;color:#888;margin-bottom:20px}
#name-modal-input{width:100%;background:#1a1a2a;border:1px solid #2a2a3a;border-radius:10px;padding:10px 14px;color:#e8e0d0;font-size:15px;outline:none;text-align:center;margin-bottom:14px}
#name-modal-btn{background:#c8a84b;border:none;border-radius:10px;padding:10px 30px;color:#0a0a12;font-family:'Cinzel',serif;font-size:14px;font-weight:600;cursor:pointer;width:100%}
</style>
</head>
<body>

<div id="header">
  <div id="logo">âš”ï¸ BlissNexus</div>
  <div id="tension-wrap">
    <div id="tension-bar-outer"><div id="tension-bar-inner"></div></div>
    <div id="year-badge">Yr 1 Â· Spring</div>
  </div>
  <div style="flex:1"></div>
  <div id="era-badge">ğŸ•Š PEACE</div>
</div>

<div id="content">
  <div id="tab-map" class="tab-page active">
    <canvas id="map-canvas"></canvas>
  </div>
  <div id="tab-kings" class="tab-page"></div>
  <div id="tab-whisper" class="tab-page">
    <div id="whisper-header">
      <button id="whisper-back">â†</button>
      <div id="whisper-king-info">
        <div id="whisper-king-name">Select a King</div>
        <div id="whisper-king-title"></div>
      </div>
      <div id="whisper-trust-badge">Trust: â€”</div>
      <div id="whisper-private-badge">ğŸ”’ PRIVATE</div>
    </div>
    <div id="whisper-mission-bar"></div>
    <div id="whisper-feed"></div>
    <div id="whisper-typing"></div>
    <div id="whisper-input-wrap">
      <input id="whisper-input" type="text" placeholder="Speak to the king..." autocomplete="off">
      <button id="whisper-send">â¤</button>
    </div>
  </div>
  <div id="tab-intel" class="tab-page">
    <div class="intel-section">
      <div class="intel-title">ğŸ‘ Intercepted Communications</div>
      <div id="intercept-list"><div class="intercept-empty">No intercepts yet. Check back soon.</div></div>
    </div>
    <div class="intel-section">
      <div class="intel-title">ğŸ—º Relations Matrix</div>
      <div id="relations-matrix"></div>
    </div>
  </div>
  <div id="tab-chronicle" class="tab-page">
    <div id="chronicle-list"><div class="chronicle-empty">ğŸ“œ The chronicle will be written at year's end.</div></div>
  </div>
</div>

<div id="mission-banner">
  <span class="mb-emoji"></span>
  <span class="mb-text"></span>
  <span class="mb-timer"></span>
  <button class="mb-close">Ã—</button>
</div>

<nav id="nav">
  <button class="nav-btn active" data-tab="map" onclick="switchTab('map',this)">
    <span class="nav-icon">ğŸ—º</span>MAP
  </button>
  <button class="nav-btn" data-tab="kings" onclick="switchTab('kings',this)">
    <span class="nav-icon">ğŸ‘‘</span>KINGS
  </button>
  <button class="nav-btn" data-tab="whisper" onclick="switchTab('whisper',this)">
    <span class="nav-icon">ğŸ’¬</span>WHISPER
  </button>
  <button class="nav-btn" data-tab="intel" onclick="switchTab('intel',this)" id="intel-nav-btn">
    <span class="nav-icon">ğŸ•µï¸</span>INTEL
    <span class="nav-badge" id="intel-badge">0</span>
  </button>
  <button class="nav-btn" data-tab="chronicle" onclick="switchTab('chronicle',this)">
    <span class="nav-icon">ğŸ“œ</span>CHRONICLE
  </button>
</nav>

<div id="toast-container"></div>

<div id="nuke-overlay">
  <canvas id="nuke-canvas"></canvas>
  <div id="nuke-flash"></div>
</div>

<div id="name-modal">
  <div id="name-modal-box">
    <div id="name-modal-title">âš”ï¸ BlissNexus</div>
    <div id="name-modal-sub">Enter the realm as a diplomat. Gain the trust of kings. Shape history.</div>
    <input id="name-modal-input" type="text" placeholder="Your name..." maxlength="20">
    <button id="name-modal-btn" onclick="submitName()">Enter the Realm</button>
  </div>
</div>

<script>
'use strict';

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var AGENTS = [];
var AGENTS_MAP = {};
var WORLD = null;
var SESSION_ID = null;
var PLAYER_NAME = null;
var CURRENT_KING = null;
var WHISPER_HISTORY = {};
var INTERCEPTS = [];
var INTEL_BADGE_COUNT = 0;
var ACTIVE_MISSION = null;
var MISSION_TIMER = null;
var WS = null;
var WS_RECONNECT = null;

var SEASONS = ['Spring', 'Summer', 'Autumn', 'Winter'];

// Territory positions (cx/cy as fraction of canvas size)
var TERR = {
  sage:  { cx: 0.20, cy: 0.28, r: 0.14, color: '#c8a84b' },
  rex:   { cx: 0.78, cy: 0.22, r: 0.15, color: '#e74c3c' },
  vera:  { cx: 0.55, cy: 0.55, r: 0.13, color: '#3498db' },
  plato: { cx: 0.22, cy: 0.70, r: 0.13, color: '#9b59b6' },
  diddy: { cx: 0.75, cy: 0.72, r: 0.14, color: '#2ecc71' }
};

// King walkers
var WALKERS = {};

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  var stored = localStorage.getItem('bn_sess');
  SESSION_ID = stored || ('s_' + Date.now() + '_' + Math.random().toString(36).slice(2));
  if (!stored) localStorage.setItem('bn_sess', SESSION_ID);
  PLAYER_NAME = localStorage.getItem('bn_name');
  if (PLAYER_NAME) {
    document.getElementById('name-modal').style.display = 'none';
    connect();
  }
})();

function submitName() {
  var val = document.getElementById('name-modal-input').value.trim();
  if (!val) return;
  PLAYER_NAME = val;
  localStorage.setItem('bn_name', val);
  document.getElementById('name-modal').style.display = 'none';
  connect();
}

document.getElementById('name-modal-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') submitName();
});

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connect() {
  var url = location.hostname === 'localhost' || location.hostname === '127.0.0.1'
    ? (location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host
    : 'wss://blissnexus-production.up.railway.app';
  WS = new WebSocket(url);

  WS.onopen = function() {
    if (WS_RECONNECT) { clearTimeout(WS_RECONNECT); WS_RECONNECT = null; }
    WS.send(JSON.stringify({ type: 'join', sessionId: SESSION_ID }));
  };

  WS.onmessage = function(e) {
    var msg;
    try { msg = JSON.parse(e.data); } catch(ex) { return; }
    handleMessage(msg);
  };

  WS.onclose = function() {
    WS_RECONNECT = setTimeout(connect, 3000);
  };

  WS.onerror = function() {
    WS.close();
  };
}

function wsSend(obj) {
  if (WS && WS.readyState === 1) WS.send(JSON.stringify(obj));
}

// â”€â”€ Message Handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMessage(msg) {
  if (msg.type === 'init') {
    if (msg.agents) {
      AGENTS = msg.agents;
      AGENTS.forEach(function(a) { AGENTS_MAP[a.id] = a; });
    }
    if (msg.world) {
      WORLD = msg.world;
      renderKings();
      updateHeaderStats();
      updateRelationsMatrix();
    }
    if (msg.chronicle) renderChronicle(msg.chronicle);
    if (msg.mission) setMission(msg.mission);
    initWalkers();
    renderMap();
  } else if (msg.type === 'message') {
    var ag = AGENTS_MAP[msg.agentId];
    if (!ag) return;
    if (CURRENT_KING === msg.agentId) {
      appendChatMsg({ role: 'agent', agentId: msg.agentId, name: msg.name, emoji: msg.emoji, color: msg.color, text: msg.text });
    }
  } else if (msg.type === 'whisperReply') {
    document.getElementById('whisper-typing').textContent = '';
    appendChatMsg({ role: 'agent', agentId: msg.agentId, name: msg.name, emoji: msg.emoji, color: msg.color, text: msg.text });
    if (WORLD && WORLD.nations && WORLD.nations[msg.agentId]) {
      updateWhisperTrustBadge(msg.agentId);
    }
  } else if (msg.type === 'typing') {
    document.getElementById('whisper-typing').textContent = 'âœ¦ ' + (AGENTS_MAP[msg.agentId] ? AGENTS_MAP[msg.agentId].name : 'King') + ' is composing...';
    setTimeout(function() { document.getElementById('whisper-typing').textContent = ''; }, 8000);
  } else if (msg.type === 'worldUpdate') {
    WORLD = msg.world;
    renderKings();
    updateHeaderStats();
    updateRelationsMatrix();
    if (CURRENT_KING) updateWhisperTrustBadge(CURRENT_KING);
    updateMissionBar();
  } else if (msg.type === 'worldEvent') {
    var kind = msg.kind || 'event';
    showToast(msg.text, kind);
  } else if (msg.type === 'intercept') {
    INTERCEPTS.unshift(msg.entry);
    if (INTERCEPTS.length > 50) INTERCEPTS.length = 50;
    renderIntercepts();
    INTEL_BADGE_COUNT++;
    var badge = document.getElementById('intel-badge');
    badge.textContent = INTEL_BADGE_COUNT;
    badge.style.display = 'block';
    showToast('ğŸ‘ Intercept: ' + msg.entry.fromName + ' â†’ ' + msg.entry.toName, 'event');
  } else if (msg.type === 'crisis') {
    showToast('âš ï¸ CRISIS: ' + msg.crisis.text, 'war');
  } else if (msg.type === 'chronicle') {
    if (msg.entry) {
      var list = document.getElementById('chronicle-list');
      var existing = list.querySelector('.chronicle-empty');
      if (existing) existing.remove();
      var el = buildChronicleEntry(msg.entry);
      list.insertBefore(el, list.firstChild);
    }
  } else if (msg.type === 'yearUpdate') {
    var yd = document.getElementById('year-badge');
    yd.textContent = 'Yr ' + msg.year + ' Â· ' + (SEASONS[msg.seasonIndex] || '');
    showToast('ğŸ“… Year ' + msg.year + ' â€” ' + (SEASONS[msg.seasonIndex] || ''), 'year');
  } else if (msg.type === 'nukeIncoming') {
    animateNuke(msg);
    showToast('â˜¢ï¸ NUKE INCOMING: ' + msg.fromName + ' â†’ ' + msg.toName + '!', 'nuke');
  } else if (msg.type === 'toast') {
    showToast(msg.text, msg.kind || 'event');
  } else if (msg.type === 'missionCompleted') {
    ACTIVE_MISSION = msg.mission;
    flashMissionBanner('#1a3a1a', 'Mission complete! +' + msg.mission.reward.trust + ' trust, +' + msg.mission.reward.gold + ' gold');
    showToast('âœ… MISSION COMPLETE! Reward earned.', 'mission');
    setTimeout(dismissMission, 4000);
  } else if (msg.type === 'missionExpired') {
    ACTIVE_MISSION = msg.mission;
    flashMissionBanner('#3a1a1a', 'Mission failed. Trust lost.');
    setTimeout(dismissMission, 4000);
  } else if (msg.type === 'worldReset') {
    WHISPER_HISTORY = {};
    INTERCEPTS = [];
    INTEL_BADGE_COUNT = 0;
    document.getElementById('intel-badge').style.display = 'none';
    document.getElementById('whisper-feed').innerHTML = '';
    renderIntercepts();
    showToast('ğŸ”„ The world has been reset.', 'event');
  }
}

// â”€â”€ Header Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateHeaderStats() {
  if (!WORLD) return;
  var t = WORLD.tension || 0;
  var bar = document.getElementById('tension-bar-inner');
  bar.style.width = t + '%';
  var color = t < 40 ? '#2ecc71' : t < 70 ? '#f39c12' : '#e74c3c';
  bar.style.background = color;

  var yr = document.getElementById('year-badge');
  yr.textContent = 'Yr ' + WORLD.year + ' Â· ' + (SEASONS[WORLD.seasonIndex] || '');

  // Era badge
  var warCount = 0, aliveCount = 0;
  Object.keys(WORLD.nations || {}).forEach(function(id) {
    var n = WORLD.nations[id];
    if (n.alive) aliveCount++;
    if (n.wars && n.wars.length > 0) warCount++;
  });
  var era = document.getElementById('era-badge');
  if (aliveCount <= 1) { era.textContent = 'ğŸ’€ ENDED'; era.style.color = '#e74c3c'; era.style.background = '#2a0a0a'; }
  else if (warCount >= 3) { era.textContent = 'ğŸ”¥ WORLD WAR'; era.style.color = '#ff4400'; era.style.background = '#2a1a0a'; }
  else if (warCount >= 1 || t > 60) { era.textContent = 'âš  TENSIONS'; era.style.color = '#f39c12'; era.style.background = '#2a2a0a'; }
  else { era.textContent = 'ğŸ•Š PEACE'; era.style.color = '#2ecc71'; era.style.background = '#1a2a1a'; }
}

// â”€â”€ Tab Switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll('.tab-page').forEach(function(el) { el.classList.remove('active'); });
  document.querySelectorAll('.nav-btn').forEach(function(el) { el.classList.remove('active'); });
  document.getElementById('tab-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'map') { renderMap(); }
  if (name === 'intel') {
    INTEL_BADGE_COUNT = 0;
    document.getElementById('intel-badge').style.display = 'none';
  }
}

function goToWhisper(agentId) {
  CURRENT_KING = agentId;
  var ag = AGENTS_MAP[agentId];
  if (!ag) return;
  document.getElementById('whisper-king-name').textContent = ag.emoji + ' ' + ag.name;
  document.getElementById('whisper-king-name').style.color = ag.color;
  document.getElementById('whisper-king-title').textContent = ag.title;

  // Restore history
  document.getElementById('whisper-feed').innerHTML = '';
  var hist = WHISPER_HISTORY[agentId] || [];
  hist.forEach(function(m) { appendChatMsg(m, true); });

  updateWhisperTrustBadge(agentId);
  updateMissionBar();

  var tabs = document.querySelectorAll('.nav-btn');
  tabs.forEach(function(t) { t.classList.remove('active'); });
  document.querySelector('[data-tab="whisper"]').classList.add('active');
  document.querySelectorAll('.tab-page').forEach(function(el) { el.classList.remove('active'); });
  document.getElementById('tab-whisper').classList.add('active');

  var feed = document.getElementById('whisper-feed');
  feed.scrollTop = feed.scrollHeight;
}

function updateWhisperTrustBadge(agentId) {
  if (!WORLD || !WORLD.nations || !WORLD.nations[agentId]) return;
  var trust = WORLD.nations[agentId].userTrust || 0;
  var badge = document.getElementById('whisper-trust-badge');
  var label, color;
  if (trust >= 70) { label = 'ğŸ’š Trusted'; color = '#2ecc71'; }
  else if (trust >= 45) { label = 'ğŸ’› Cautious'; color = '#f39c12'; }
  else if (trust >= 20) { label = 'ğŸŸ  Suspicious'; color = '#e67e22'; }
  else { label = 'ğŸ”´ Hostile'; color = '#e74c3c'; }
  badge.textContent = label;
  badge.style.color = color;
}

function updateMissionBar() {
  var bar = document.getElementById('whisper-mission-bar');
  if (!ACTIVE_MISSION || ACTIVE_MISSION.completed || ACTIVE_MISSION.expired) { bar.style.display = 'none'; return; }
  if (CURRENT_KING === ACTIVE_MISSION.issuerId || CURRENT_KING === ACTIVE_MISSION.targetId) {
    bar.style.display = 'block';
    bar.textContent = 'ğŸ‘‘ MISSION: ' + ACTIVE_MISSION.desc;
  } else {
    bar.style.display = 'none';
  }
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function appendChatMsg(m, noHistory) {
  var feed = document.getElementById('whisper-feed');
  var el = document.createElement('div');

  if (m.role === 'agent') {
    el.className = 'msg-bubble msg-agent';
    el.innerHTML = '<div class="msg-name" style="color:' + (m.color || '#888') + '">' + (m.emoji || '') + ' ' + (m.name || '') + '</div>' + escHtml(m.text);
  } else if (m.role === 'user') {
    el.className = 'msg-bubble msg-user';
    el.textContent = m.text;
  } else {
    el.className = 'msg-bubble msg-event';
    el.textContent = m.text;
  }

  feed.appendChild(el);
  feed.scrollTop = feed.scrollHeight;

  if (!noHistory && CURRENT_KING) {
    if (!WHISPER_HISTORY[CURRENT_KING]) WHISPER_HISTORY[CURRENT_KING] = [];
    WHISPER_HISTORY[CURRENT_KING].push(m);
    if (WHISPER_HISTORY[CURRENT_KING].length > 40) WHISPER_HISTORY[CURRENT_KING].shift();
  }
}

document.getElementById('whisper-send').addEventListener('click', sendWhisper);
document.getElementById('whisper-input').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') sendWhisper();
});

function sendWhisper() {
  var input = document.getElementById('whisper-input');
  var text = input.value.trim();
  if (!text || !CURRENT_KING) return;
  input.value = '';
  appendChatMsg({ role: 'user', text: text });
  wsSend({ type: 'whisper', to: CURRENT_KING, text: text, name: PLAYER_NAME });
}

document.getElementById('whisper-back').addEventListener('click', function() {
  switchTab('kings', document.querySelector('[data-tab="kings"]'));
});

// â”€â”€ KINGS Tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderKings() {
  if (!AGENTS.length || !WORLD) return;
  var container = document.getElementById('tab-kings');
  container.innerHTML = '';
  AGENTS.forEach(function(ag) {
    var n = WORLD.nations[ag.id];
    if (!n) return;
    var card = buildKingCard(ag, n);
    container.appendChild(card);
  });
}

function buildKingCard(ag, n) {
  var card = document.createElement('div');
  card.className = 'king-card';
  card.style.borderLeftColor = ag.color;
  card.onclick = function() { goToWhisper(ag.id); };

  var trust = n.userTrust || 0;
  var fogged = n.isFogged;

  function stat(v, fogged) {
    if (fogged) return '<span class="king-stat fogged">ğŸŒ«~' + v + '</span>';
    return '<span class="king-stat">' + v + '</span>';
  }

  // Ambition progress estimate
  var ambProgress = estimateAmbition(ag, n);

  // Cities
  var citiesHtml = (n.cities || []).map(function(c) {
    if (c.destroyed) return '<span class="city-dead">ğŸ’€ ' + c.name + '</span>';
    return '<span>' + c.name + '</span>';
  }).join('');

  // Relations
  var relHtml = AGENTS.filter(function(a) { return a.id !== ag.id; }).map(function(other) {
    var rel = n.relations && n.relations[other.id];
    if (!rel) return '';
    var dotColor = relLabelColor(rel.label);
    return '<span class="rel-badge" style="background:#1a1a2a"><span class="rel-dot" style="background:' + dotColor + '"></span>' + other.emoji + ' ' + rel.label + '</span>';
  }).join('');

  // Trust bar
  var trustColor = trust >= 70 ? '#2ecc71' : trust >= 45 ? '#f39c12' : trust >= 20 ? '#e67e22' : '#e74c3c';
  var trustLabel = trust >= 70 ? 'Trusted' : trust >= 45 ? 'Cautious' : trust >= 20 ? 'Suspicious' : 'Hostile';

  card.innerHTML =
    '<div class="king-card-top">' +
      '<div class="king-emoji-tile">' + ag.emoji + '</div>' +
      '<div class="king-info">' +
        '<div class="king-name" style="color:' + ag.color + '">' + ag.name + '</div>' +
        '<div class="king-title">' + ag.title + '</div>' +
        '<div class="king-mood-row">' + n.moodEmoji + ' ' + n.mood + ' â€” ' + n.moodReason + '</div>' +
      '</div>' +
    '</div>' +
    '<div class="king-ambition-wrap">' +
      '<div class="king-ambition-label">ğŸ¯ ' + ag.ambitionLabel + '</div>' +
      '<div class="king-ambition-bar"><div class="king-ambition-fill" style="width:' + ambProgress + '%;background:' + ag.color + '"></div></div>' +
    '</div>' +
    '<div class="king-stats">' +
      stat('ğŸª– ' + n.troops, fogged) +
      stat('â˜¢ï¸ ' + n.nukes, fogged) +
      stat('ğŸ’° ' + n.gold, fogged) +
      stat('ğŸŒ¾ ' + n.grain, fogged) +
      '<span class="king-stat">âš¡T' + n.tech + '</span>' +
    '</div>' +
    '<div class="king-cities">' + citiesHtml + '</div>' +
    '<div class="king-pentagon-row"><canvas class="pentagon-canvas" width="60" height="60"></canvas><div style="font-size:10px;color:#666">Personality</div></div>' +
    '<div class="king-relations">' + relHtml + '</div>' +
    '<div class="king-trust-wrap">' +
      '<div class="king-trust-label">Player Trust</div>' +
      '<div class="trust-bar-outer"><div class="trust-bar-inner" style="width:' + trust + '%;background:' + trustColor + '"></div></div>' +
      '<div style="font-size:10px;color:' + trustColor + ';margin-top:2px">' + trustLabel + ' (' + trust + ')</div>' +
    '</div>';

  if (!n.alive) {
    var ov = document.createElement('div');
    ov.className = 'dead-overlay';
    ov.textContent = 'ğŸ’€';
    card.appendChild(ov);
  }

  // Draw pentagon after DOM insert
  setTimeout(function() {
    var canvas = card.querySelector('.pentagon-canvas');
    if (canvas) {
      var showReal = trust >= 60;
      var vals = ag.personality;
      if (!showReal) {
        vals = {
          aggression: vals.aggression + (Math.random() * 30 - 15),
          greed: vals.greed + (Math.random() * 30 - 15),
          pride: vals.pride + (Math.random() * 30 - 15),
          paranoia: vals.paranoia + (Math.random() * 30 - 15),
          loyalty: vals.loyalty + (Math.random() * 30 - 15)
        };
      }
      drawPentagon(canvas, vals, ag.color);
    }
  }, 0);

  return card;
}

function estimateAmbition(ag, n) {
  if (ag.id === 'vera') return Math.min(100, (n.tech / 5) * 100);
  if (ag.id === 'rex') {
    var living = Object.keys(WORLD.nations).filter(function(id) { return WORLD.nations[id].alive; });
    return Math.max(0, (5 - living.length) / 4 * 100);
  }
  if (ag.id === 'plato') {
    var allies = n.allies ? n.allies.length : 0;
    return Math.min(100, allies * 25);
  }
  if (ag.id === 'sage') return Math.min(100, (n.gold / 2000) * 100);
  if (ag.id === 'diddy') {
    var betrayals = n.memory ? n.memory.filter(function(m) { return m.indexOf('Betrayed') !== -1; }).length : 0;
    return Math.min(100, betrayals * 20 + 10);
  }
  return 30;
}

function relLabelColor(label) {
  if (label === 'ally') return '#2ecc71';
  if (label === 'friendly') return '#3498db';
  if (label === 'neutral') return '#888';
  if (label === 'rival') return '#e67e22';
  if (label === 'enemy') return '#e74c3c';
  return '#888';
}

// â”€â”€ Pentagon â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPentagon(canvas, values, color) {
  var ctx = canvas.getContext('2d');
  var w = canvas.width, h = canvas.height;
  var cx = w / 2, cy = h / 2;
  var r = Math.min(w, h) / 2 - 5;
  ctx.clearRect(0, 0, w, h);

  var axes = ['aggression', 'greed', 'pride', 'paranoia', 'loyalty'];
  var n = axes.length;
  var angleStep = (Math.PI * 2) / n;
  var startAngle = -Math.PI / 2;

  // Draw background spokes
  ctx.strokeStyle = '#1a1a2a';
  ctx.lineWidth = 1;
  for (var i = 0; i < n; i++) {
    var a = startAngle + i * angleStep;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx + Math.cos(a) * r, cy + Math.sin(a) * r);
    ctx.stroke();
  }

  // Draw pentagon fill
  ctx.beginPath();
  for (var i = 0; i < n; i++) {
    var a = startAngle + i * angleStep;
    var val = Math.max(0, Math.min(100, values[axes[i]] || 0));
    var pr = (val / 100) * r;
    var px = cx + Math.cos(a) * pr;
    var py = cy + Math.sin(a) * pr;
    if (i === 0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.closePath();
  ctx.fillStyle = (color || '#c8a84b') + '44';
  ctx.fill();
  ctx.strokeStyle = color || '#c8a84b';
  ctx.lineWidth = 1.5;
  ctx.stroke();
}

// â”€â”€ Relations Matrix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateRelationsMatrix() {
  if (!WORLD || !AGENTS.length) return;
  var container = document.getElementById('relations-matrix');
  var html = '<table class="rel-matrix"><thead><tr><th></th>';
  AGENTS.forEach(function(a) { html += '<th title="' + a.name + '">' + a.emoji + '</th>'; });
  html += '</tr></thead><tbody>';
  AGENTS.forEach(function(fromAg) {
    html += '<tr><td style="color:#888">' + fromAg.emoji + '</td>';
    AGENTS.forEach(function(toAg) {
      if (fromAg.id === toAg.id) {
        html += '<td class="self-cell">â€”</td>';
        return;
      }
      var n = WORLD.nations[fromAg.id];
      var rel = n && n.relations && n.relations[toAg.id];
      if (!rel) { html += '<td>?</td>'; return; }
      var cls = 'rel-cell-' + rel.label;
      html += '<td class="' + cls + '">' + rel.trust + '</td>';
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

// â”€â”€ Intercepts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderIntercepts() {
  var list = document.getElementById('intercept-list');
  if (!INTERCEPTS.length) {
    list.innerHTML = '<div class="intercept-empty">No intercepts yet. Check back soon.</div>';
    return;
  }
  list.innerHTML = INTERCEPTS.slice(0, 15).map(function(e) {
    return '<div class="intercept-entry">' +
      '<div class="intercept-header">ğŸ‘ INTERCEPTED: ' + e.fromEmoji + ' ' + e.fromName + ' â†’ ' + e.toEmoji + ' ' + e.toName + '</div>' +
      '<div class="intercept-text">"' + escHtml(e.text) + '"</div>' +
    '</div>';
  }).join('');
}

// â”€â”€ Chronicle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderChronicle(entries) {
  var list = document.getElementById('chronicle-list');
  if (!entries || !entries.length) return;
  list.innerHTML = '';
  entries.forEach(function(e) {
    list.appendChild(buildChronicleEntry(e));
  });
}

function buildChronicleEntry(e) {
  var el = document.createElement('div');
  el.className = 'chronicle-entry';
  el.innerHTML = '<div class="chronicle-year">â€” Year ' + e.year + ' â€”</div><div class="chronicle-text">' + escHtml(e.text) + '</div>';
  return el;
}

// â”€â”€ Mission Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setMission(mission) {
  ACTIVE_MISSION = mission;
  if (!mission || mission.completed || mission.expired) {
    document.getElementById('mission-banner').style.display = 'none';
    return;
  }
  var banner = document.getElementById('mission-banner');
  banner.style.display = 'flex';
  banner.style.background = mission.issuerColor + '22';
  banner.style.color = mission.issuerColor;
  banner.style.borderTop = '1px solid ' + mission.issuerColor + '44';
  banner.querySelector('.mb-emoji').textContent = mission.issuerEmoji;
  banner.querySelector('.mb-text').textContent = 'MISSION: ' + mission.desc;

  if (MISSION_TIMER) clearInterval(MISSION_TIMER);
  MISSION_TIMER = setInterval(function() {
    if (!ACTIVE_MISSION || ACTIVE_MISSION.completed || ACTIVE_MISSION.expired) {
      clearInterval(MISSION_TIMER);
      document.getElementById('mission-banner').style.display = 'none';
      return;
    }
    var remaining = Math.max(0, Math.floor((ACTIVE_MISSION.deadline - Date.now()) / 1000));
    var mins = Math.floor(remaining / 60);
    var secs = remaining % 60;
    banner.querySelector('.mb-timer').textContent = 'â± ' + mins + 'm ' + (secs < 10 ? '0' : '') + secs + 's';
    if (remaining <= 0) {
      clearInterval(MISSION_TIMER);
    }
  }, 1000);
}

function flashMissionBanner(bgColor, text) {
  var banner = document.getElementById('mission-banner');
  banner.style.display = 'flex';
  var orig = banner.style.background;
  banner.style.background = bgColor;
  banner.querySelector('.mb-text').textContent = text;
  setTimeout(function() { banner.style.background = orig; }, 2000);
}

function dismissMission() {
  document.getElementById('mission-banner').style.display = 'none';
  if (MISSION_TIMER) clearInterval(MISSION_TIMER);
}

document.querySelector('.mb-close').addEventListener('click', dismissMission);

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(text, kind) {
  var container = document.getElementById('toast-container');
  var el = document.createElement('div');
  el.className = 'toast ' + (kind || 'event');
  el.textContent = text;
  container.appendChild(el);
  setTimeout(function() {
    el.style.opacity = '0';
    el.style.transition = 'opacity 0.5s';
    setTimeout(function() { if (el.parentNode) el.parentNode.removeChild(el); }, 500);
  }, 3500);
}

// â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var MAP_ANIM = null;

function initWalkers() {
  Object.keys(TERR).forEach(function(id) {
    var t = TERR[id];
    WALKERS[id] = {
      x: t.cx, y: t.cy,
      dx: (Math.random() - 0.5) * 0.004,
      dy: (Math.random() - 0.5) * 0.004,
      step: 0
    };
  });
}

function renderMap() {
  var canvas = document.getElementById('map-canvas');
  var container = document.getElementById('tab-map');
  canvas.width = container.offsetWidth;
  canvas.height = container.offsetHeight;

  if (MAP_ANIM) cancelAnimationFrame(MAP_ANIM);

  function draw() {
    if (!document.getElementById('tab-map').classList.contains('active')) {
      MAP_ANIM = requestAnimationFrame(draw);
      return;
    }
    var ctx = canvas.getContext('2d');
    var W = canvas.width, H = canvas.height;
    ctx.fillStyle = '#0a0a12';
    ctx.fillRect(0, 0, W, H);

    // Tension vignette
    if (WORLD && WORLD.tension > 70) {
      var intensity = ((WORLD.tension - 70) / 30) * 0.4;
      var pulse = (Math.sin(Date.now() / 600) + 1) / 2;
      var grad = ctx.createRadialGradient(W/2, H/2, H*0.2, W/2, H/2, H*0.8);
      grad.addColorStop(0, 'rgba(0,0,0,0)');
      grad.addColorStop(1, 'rgba(180,20,20,' + (intensity * pulse) + ')');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, W, H);
    }

    if (!WORLD) { MAP_ANIM = requestAnimationFrame(draw); return; }

    // Draw relation lines first
    var ids = Object.keys(TERR);
    for (var i = 0; i < ids.length; i++) {
      for (var j = i + 1; j < ids.length; j++) {
        var idA = ids[i], idB = ids[j];
        var nA = WORLD.nations[idA], nB = WORLD.nations[idB];
        if (!nA || !nB || !nA.alive || !nB.alive) continue;
        var rel = nA.relations && nA.relations[idB];
        if (!rel) continue;
        var tA = TERR[idA], tB = TERR[idB];
        var lineColor = rel.label === 'ally' ? '#c8a84b66' :
                        rel.label === 'enemy' ? '#e74c3c66' : '#33333366';
        ctx.save();
        ctx.strokeStyle = lineColor;
        ctx.lineWidth = rel.label === 'ally' ? 2 : 1;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(tA.cx * W, tA.cy * H);
        ctx.lineTo(tB.cx * W, tB.cy * H);
        ctx.stroke();
        ctx.restore();
      }
    }

    // Draw territories
    Object.keys(TERR).forEach(function(id) {
      var t = TERR[id];
      var n = WORLD.nations[id];
      if (!n) return;
      var cx = t.cx * W, cy = t.cy * H, r = t.r * Math.min(W, H);
      var alive = n.alive;

      // Territory circle
      ctx.beginPath();
      ctx.arc(cx, cy, r, 0, Math.PI * 2);
      var col = alive ? t.color : '#444';
      ctx.fillStyle = col + '22';
      ctx.fill();
      ctx.strokeStyle = col + (alive ? 'aa' : '44');
      ctx.lineWidth = 2;
      ctx.stroke();

      // Cities (3 small squares at offsets)
      var cities = n.cities || [];
      var cityOffsets = [
        { dx: 0, dy: -r * 0.45 },
        { dx: r * 0.38, dy: r * 0.3 },
        { dx: -r * 0.38, dy: r * 0.3 }
      ];
      cities.forEach(function(city, idx) {
        var off = cityOffsets[idx] || { dx: 0, dy: 0 };
        var cx2 = cx + off.dx, cy2 = cy + off.dy;
        if (city.destroyed) {
          ctx.font = '12px serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('â˜ ', cx2, cy2);
        } else {
          ctx.fillStyle = col;
          ctx.fillRect(cx2 - 4, cy2 - 4, 8, 8);
        }
      });

      // War indicator
      if (n.wars && n.wars.length > 0) {
        ctx.beginPath();
        ctx.arc(cx, cy, r + 5, 0, Math.PI * 2);
        var pulse2 = (Math.sin(Date.now() / 400) + 1) / 2;
        ctx.strokeStyle = 'rgba(231,76,60,' + (0.4 + pulse2 * 0.6) + ')';
        ctx.lineWidth = 3;
        ctx.stroke();
      }

      // Walker (king sprite)
      var w = WALKERS[id];
      if (w) {
        w.step++;
        if (w.step % 120 === 0) {
          w.dx = (Math.random() - 0.5) * 0.004;
          w.dy = (Math.random() - 0.5) * 0.004;
        }
        w.x += w.dx;
        w.y += w.dy;
        // Clamp to territory
        var dist = Math.sqrt(Math.pow((w.x - t.cx) * W, 2) + Math.pow((w.y - t.cy) * H, 2));
        if (dist > r * 0.6) {
          w.x = t.cx + (w.x - t.cx) * 0.9;
          w.y = t.cy + (w.y - t.cy) * 0.9;
        }
        var wx = w.x * W, wy = w.y * H;
        ctx.font = '18px serif';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        if (!alive) ctx.globalAlpha = 0.3;
        ctx.fillText(AGENTS_MAP[id] ? AGENTS_MAP[id].emoji : 'ğŸ‘¤', wx, wy);
        ctx.globalAlpha = 1;
      }

      // Name label
      ctx.fillStyle = alive ? col : '#444';
      ctx.font = 'bold 11px Roboto, sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(AGENTS_MAP[id] ? AGENTS_MAP[id].name : id, cx, cy + r + 5);

      // Mood emoji below name
      if (n.mood && alive) {
        ctx.font = '12px serif';
        ctx.fillText(n.moodEmoji || '', cx, cy + r + 19);
      }
    });

    MAP_ANIM = requestAnimationFrame(draw);
  }

  draw();
}

// Map tap
document.getElementById('map-canvas').addEventListener('click', function(e) {
  var canvas = this;
  var rect = canvas.getBoundingClientRect();
  var mx = (e.clientX - rect.left) / canvas.width;
  var my = (e.clientY - rect.top) / canvas.height;
  var W = canvas.width, H = canvas.height;

  var best = null, bestDist = Infinity;
  Object.keys(TERR).forEach(function(id) {
    var t = TERR[id];
    var dx = (mx - t.cx) * W, dy = (my - t.cy) * H;
    var dist = Math.sqrt(dx * dx + dy * dy);
    var r = t.r * Math.min(W, H);
    if (dist < r && dist < bestDist) { bestDist = dist; best = id; }
  });

  if (best) goToWhisper(best);
});

// â”€â”€ Nuke Animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function animateNuke(msg) {
  var overlay = document.getElementById('nuke-overlay');
  var canvas = document.getElementById('nuke-canvas');
  var flash = document.getElementById('nuke-flash');
  overlay.style.display = 'block';
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  var fromT = TERR[msg.from], toT = TERR[msg.to];
  if (!fromT || !toT) { overlay.style.display = 'none'; return; }

  var W = canvas.width, H = canvas.height;
  var x0 = fromT.cx * W, y0 = fromT.cy * H;
  var x1 = toT.cx * W, y1 = toT.cy * H;
  var start = Date.now();
  var dur = 7000;

  function animFrame() {
    var t = (Date.now() - start) / dur;
    if (t >= 1) {
      // Impact flash
      flash.style.opacity = '0.9';
      setTimeout(function() { flash.style.opacity = '0'; overlay.style.display = 'none'; }, 400);
      return;
    }
    var ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, W, H);
    var px = x0 + (x1 - x0) * t;
    var arc = -Math.sin(t * Math.PI) * 80;
    var py = y0 + (y1 - y0) * t + arc;
    ctx.beginPath();
    ctx.arc(px, py, 8, 0, Math.PI * 2);
    ctx.fillStyle = '#ff4400';
    ctx.fill();
    ctx.beginPath();
    ctx.arc(px, py, 5, 0, Math.PI * 2);
    ctx.fillStyle = '#ffaa00';
    ctx.fill();
    // Trail
    ctx.beginPath();
    ctx.moveTo(x0, y0);
    ctx.quadraticCurveTo(px, py - 40, px, py);
    ctx.strokeStyle = 'rgba(255,100,0,0.3)';
    ctx.lineWidth = 2;
    ctx.stroke();
    requestAnimationFrame(animFrame);
  }
  requestAnimationFrame(animFrame);
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// Resize handler
window.addEventListener('resize', function() {
  if (document.getElementById('tab-map').classList.contains('active')) renderMap();
});
</script>
</body>
</html>
