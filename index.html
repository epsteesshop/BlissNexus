<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>BlissNexus</title>
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#060810; --bg2:#0b0d18; --bg3:#10121e; --border:#1c1f30;
  --tx:#b8c4e0; --dm:#363d5a; --acc:#00ff88;
  --tab-h:60px; --safe-b:env(safe-area-inset-bottom,0px);
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{height:100%;background:var(--bg);}
body{height:100%;background:var(--bg);color:var(--tx);font-family:'Inter',sans-serif;overflow:hidden;-webkit-font-smoothing:antialiased;}

/* â”€â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hdr{
  position:fixed;top:0;left:0;right:0;
  height:52px;padding-top:env(safe-area-inset-top,0px);
  display:flex;align-items:center;padding-left:16px;padding-right:16px;gap:10px;
  background:rgba(6,8,16,.96);border-bottom:1px solid var(--border);
  z-index:100;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
}
.logo{font-family:'Orbitron',monospace;font-size:.9rem;font-weight:900;letter-spacing:.04em;
  background:linear-gradient(90deg,#00ff88,#4488ff,#ff4488);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
#era{
  margin-left:auto;font-family:'Orbitron',monospace;font-size:.44rem;letter-spacing:.08em;
  padding:3px 10px;border-radius:20px;border:1px solid currentColor;white-space:nowrap;transition:all .4s;
}
.ep{color:#00cc66;border-color:#00cc6640;background:#00cc6608;}
.et{color:#ffcc00;border-color:#ffcc0040;background:#ffcc0008;}
.ew{color:#ff6600;border-color:#ff660040;background:#ff660010;animation:blink 1s infinite;}
.en{color:#ff2244;border-color:#ff224450;background:#ff224412;animation:blink .5s infinite;}
.ee{color:#552233;border-color:#33111a;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}
#live{width:6px;height:6px;border-radius:50%;background:var(--acc);box-shadow:0 0 7px var(--acc);animation:blink 2s infinite;flex-shrink:0;}

/* â”€â”€â”€ TAB PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#pages{
  position:fixed;
  top:52px;left:0;right:0;
  bottom:calc(var(--tab-h) + var(--safe-b));
  overflow:hidden;
}
.page{position:absolute;inset:0;overflow:hidden;display:none;}
.page.active{display:block;}
#page-chat.active{display:flex!important;flex-direction:column;}
#page-events.active{display:flex!important;flex-direction:column;}

/* â”€â”€â”€ MAP PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#page-map{background:#060c14;}
#map-canvas{display:block;width:100%;height:100%;touch-action:manipulation;}
#nuke-warn{
  display:none;position:absolute;top:10px;left:50%;transform:translateX(-50%);
  background:#1a0010;border:1px solid #ff2244;border-radius:8px;
  padding:6px 18px;font-family:'Orbitron',monospace;font-size:.5rem;
  color:#ff2244;letter-spacing:.1em;white-space:nowrap;z-index:10;animation:blink .4s infinite;
}

/* â”€â”€â”€ KINGS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#page-kings{background:var(--bg2);overflow-y:auto;-webkit-overflow-scrolling:touch;}
.king-card{
  display:flex;align-items:center;gap:12px;padding:14px 16px;
  border-bottom:1px solid var(--border);cursor:pointer;
  border-left:3px solid transparent;transition:background .15s;
  -webkit-user-select:none;user-select:none;
}
.king-card:active{background:var(--bg3);}
.king-card.dead{opacity:.3;pointer-events:none;}
.k-avatar{
  width:44px;height:44px;border-radius:10px;display:flex;align-items:center;
  justify-content:center;font-size:1.4rem;flex-shrink:0;
  background:var(--bg3);border:1px solid var(--border);
}
.k-body{flex:1;min-width:0;}
.k-name{font-size:.72rem;font-weight:600;}
.k-title{font-size:.52rem;color:var(--dm);margin-top:2px;}
.k-row{display:flex;align-items:center;gap:8px;margin-top:6px;}
.k-stat{font-size:.5rem;color:var(--dm);}
.k-stat b{font-weight:600;}
.k-badge{font-size:.44rem;font-family:'Orbitron',monospace;letter-spacing:.05em;padding:2px 8px;border-radius:10px;}
.kb-war{color:#ff5533;background:#1a0800;border:1px solid #ff553330;}
.kb-peace{color:#667799;}
.kb-ally{color:#ffcc00;background:#1a1400;border:1px solid #ffcc0030;}
.k-arrow{color:var(--dm);font-size:1rem;flex-shrink:0;}

/* â”€â”€â”€ CHAT PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#page-chat{background:var(--bg2);display:flex;flex-direction:column;}
#chat-hdr{
  padding:12px 16px;border-bottom:1px solid var(--border);
  background:var(--bg3);display:flex;align-items:center;gap:10px;flex-shrink:0;
}
#chat-back{
  background:none;border:none;color:var(--dm);font-size:1.2rem;padding:0 6px 0 0;
  cursor:pointer;line-height:1;
}
#chat-king-name{font-size:.72rem;font-weight:600;}
#chat-king-title{font-size:.48rem;color:var(--dm);margin-top:2px;}
.enc{font-size:.38rem;color:#00995544;margin-left:auto;font-family:'Orbitron',monospace;letter-spacing:.06em;}

#feed{
  flex:1;overflow-y:auto;padding:12px 14px;
  display:flex;flex-direction:column;gap:8px;
  -webkit-overflow-scrolling:touch;
}
.msg-row{display:flex;flex-direction:column;gap:3px;}
.msg-from{font-size:.52rem;font-weight:600;padding:0 4px;}
.msg-bubble{
  font-size:.7rem;line-height:1.6;padding:9px 12px;
  border-radius:4px 14px 14px 14px;
  background:var(--bg3);border:1px solid var(--border);
}
.msg-user .msg-bubble{
  background:linear-gradient(135deg,#07190f,#060f18);
  border-color:#00ff8820;border-radius:14px 4px 14px 14px;
}
.msg-user .msg-from{text-align:right;color:#00cc66;}
.event-row{
  text-align:center;font-size:.55rem;padding:5px 10px;border-radius:6px;margin:2px 0;
}
.ev-world{color:#667799;}
.ev-war{color:#ff6644;background:#1a090020;border:1px solid #ff664420;}
.ev-nuke{color:#ff2244;background:#1a001020;border:1px solid #ff224430;animation:blink .8s infinite;}
.ev-peace{color:#00cc66;background:#001a0c20;border:1px solid #00cc6620;}
.ev-alliance{color:#ffcc00;background:#1a140020;border:1px solid #ffcc0020;}
.ev-destroyed{color:#ff4444;background:#1a0a0a20;border:1px solid #ff444430;}
.typing-wrap{display:flex;flex-direction:column;gap:3px;}
.typing-bubbles{display:flex;gap:5px;padding:10px 14px;background:var(--bg3);border:1px solid var(--border);border-radius:4px 14px 14px 14px;width:fit-content;}
.tdot{width:6px;height:6px;border-radius:50%;animation:tdot .7s ease infinite;}
.tdot:nth-child(2){animation-delay:.15s}.tdot:nth-child(3){animation-delay:.3s}
@keyframes tdot{0%,60%,100%{opacity:.2;transform:scale(.8)}30%{opacity:1;transform:scale(1.1)}}
.empty-chat{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:10px;padding:30px;text-align:center;
}
.empty-chat .icon{font-size:2.5rem;opacity:.25;}
.empty-chat .txt{font-size:.65rem;color:var(--dm);line-height:1.7;}

#input-area{
  display:flex;gap:8px;padding:10px 14px;
  padding-bottom:calc(10px + env(safe-area-inset-bottom,0px));
  border-top:1px solid var(--border);background:var(--bg2);flex-shrink:0;
}
#msg-input{
  flex:1;background:var(--bg3);border:1px solid var(--border);
  color:var(--tx);padding:10px 13px;border-radius:22px;
  font-family:inherit;font-size:16px;/* 16px prevents iOS zoom */
  outline:none;resize:none;max-height:100px;line-height:1.4;
  -webkit-appearance:none;
}
#msg-input:focus{border-color:#00ff8844;}
#send-btn{
  width:44px;height:44px;border-radius:22px;border:none;
  background:linear-gradient(135deg,#00cc6688,#004422);
  color:#00ff88;font-size:1.1rem;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:all .15s;
}
#send-btn:active{transform:scale(.93);}
#send-btn:disabled{opacity:.3;}

/* â”€â”€â”€ EVENTS PAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#page-events{background:var(--bg2);overflow-y:auto;-webkit-overflow-scrolling:touch;padding:12px 14px;display:flex;flex-direction:column;gap:6px;}
.event-card{
  padding:10px 14px;border-radius:8px;border:1px solid var(--border);
  background:var(--bg3);font-size:.6rem;line-height:1.5;
}
.event-card .ev-time{font-size:.44rem;color:var(--dm);margin-top:4px;}

/* â”€â”€â”€ BOTTOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#tab-bar{
  position:fixed;bottom:0;left:0;right:0;
  height:calc(var(--tab-h) + var(--safe-b));
  padding-bottom:var(--safe-b);
  background:rgba(6,8,16,.97);border-top:1px solid var(--border);
  display:flex;z-index:100;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);
}
.tab{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;cursor:pointer;transition:color .15s;color:var(--dm);
  border:none;background:none;-webkit-user-select:none;user-select:none;
  padding-bottom:2px;
}
.tab-icon{font-size:1.3rem;line-height:1;}
.tab-label{font-size:.42rem;font-family:'Orbitron',monospace;letter-spacing:.08em;}
.tab.active{color:var(--acc);}
.tab-badge{
  position:absolute;top:10px;right:calc(50% - 18px);
  width:8px;height:8px;background:#ff4444;border-radius:50%;
  box-shadow:0 0 6px #ff4444;display:none;
}

/* â”€â”€â”€ DESKTOP OVERRIDE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
@media(min-width:720px){
  #pages,#tab-bar{display:none!important;}
  #desktop{display:grid!important;grid-template-columns:1fr 340px;grid-template-rows:52px 1fr;height:100vh;}
  #d-map-wrap{position:relative;overflow:hidden;background:#060c14;}
  #d-map-canvas{display:block;width:100%;height:100%;}
  #d-panel{background:var(--bg2);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
  #d-roster{border-bottom:1px solid var(--border);flex-shrink:0;}
  #d-chat{flex:1;display:flex;flex-direction:column;overflow:hidden;}
  #d-chat-hdr{padding:11px 14px;border-bottom:1px solid var(--border);background:var(--bg3);flex-shrink:0;}
  #d-chat-king{font-size:.65rem;font-weight:600;}
  #d-chat-sub{font-size:.46rem;color:var(--dm);margin-top:2px;}
  #d-feed{flex:1;overflow-y:auto;padding:12px;display:flex;flex-direction:column;gap:8px;}
  #d-feed::-webkit-scrollbar{width:2px;}
  #d-feed::-webkit-scrollbar-thumb{background:var(--border);}
  #d-input{padding:10px 12px;border-top:1px solid var(--border);display:flex;gap:8px;background:var(--bg2);}
  #d-msg{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--tx);padding:8px 12px;border-radius:20px;font-family:inherit;font-size:14px;outline:none;resize:none;height:40px;}
  #d-msg:focus{border-color:#00ff8844;}
  #d-send{width:40px;height:40px;border-radius:20px;border:none;background:linear-gradient(135deg,#00cc6688,#004422);color:#00ff88;font-size:1rem;cursor:pointer;flex-shrink:0;}
  #d-nuke-warn{display:none;position:absolute;top:10px;left:50%;transform:translateX(-50%);background:#1a0010;border:1px solid #ff2244;border-radius:8px;padding:6px 18px;font-family:'Orbitron',monospace;font-size:.5rem;color:#ff2244;letter-spacing:.1em;white-space:nowrap;z-index:10;animation:blink .4s infinite;}
}
@media(max-width:719px){#desktop{display:none!important;}}

/* â”€â”€â”€ NUKE FLASH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#nuke-flash{position:fixed;inset:0;pointer-events:none;z-index:200;display:none;background:radial-gradient(ellipse at center,rgba(255,34,68,.35),transparent 70%);}
</style>
</head>
<body>

<!-- â”€â”€ HEADER (shared) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header id="hdr">
  <div>
    <div class="logo">BLISSNEXUS</div>
  </div>
  <div id="era" class="ep">ğŸ•Š PEACE</div>
  <div id="live"></div>
</header>

<!-- â”€â”€ MOBILE PAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="pages">
  <!-- MAP -->
  <div id="page-map" class="page active">
    <canvas id="map-canvas"></canvas>
    <div id="nuke-warn">â˜¢ NUCLEAR STRIKE INBOUND</div>
  </div>
  <!-- KINGS -->
  <div id="page-kings" class="page">
    <div id="roster"></div>
  </div>
  <!-- CHAT -->
  <div id="page-chat" class="page">
    <div id="chat-hdr">
      <button id="chat-back" onclick="showTab('kings')">â€¹</button>
      <div>
        <div id="chat-king-name" style="color:var(--dm)">No king selected</div>
        <div id="chat-king-title">Select a kingdom first</div>
      </div>
      <div class="enc">ğŸ”’ PRIVATE</div>
    </div>
    <div id="feed">
      <div class="empty-chat" id="empty-chat">
        <div class="icon">ğŸ‘‘</div>
        <div class="txt">Select a king from the<br>KINGS tab to open<br>a private channel.</div>
      </div>
    </div>
    <div id="input-area">
      <textarea id="msg-input" placeholder="Whisper to the kingâ€¦" disabled rows="1"></textarea>
      <button id="send-btn" disabled>â†‘</button>
    </div>
  </div>
  <!-- EVENTS -->
  <div id="page-events" class="page">
    <div id="event-list"></div>
  </div>
</div>

<!-- â”€â”€ BOTTOM NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="tab-bar">
  <button class="tab active" onclick="showTab('map')" id="tb-map">
    <span class="tab-icon">ğŸ—ºï¸</span>
    <span class="tab-label">MAP</span>
  </button>
  <button class="tab" onclick="showTab('kings')" id="tb-kings">
    <span class="tab-icon">ğŸ‘‘</span>
    <span class="tab-label">KINGS</span>
  </button>
  <button class="tab" onclick="showTab('chat')" id="tb-chat">
    <span class="tab-icon">ğŸ’¬</span>
    <span class="tab-label">WHISPER</span>
  </button>
  <button class="tab" onclick="showTab('events')" id="tb-events" style="position:relative">
    <span class="tab-icon">ğŸ“œ</span>
    <span class="tab-label">EVENTS</span>
    <span class="tab-badge" id="events-badge"></span>
  </button>
</div>

<!-- â”€â”€ DESKTOP LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="desktop" style="display:none">
  <header id="d-hdr" style="grid-column:1/-1;display:flex;align-items:center;padding:0 20px;gap:12px;background:rgba(6,8,16,.97);border-bottom:1px solid var(--border);z-index:20;">
    <div><div class="logo">BLISSNEXUS</div><div style="font-size:.4rem;color:var(--dm);letter-spacing:.2em;margin-top:1px">THE FIVE KINGDOMS</div></div>
    <div id="d-era" class="ep" style="margin-left:auto;font-family:'Orbitron',monospace;font-size:.5rem;letter-spacing:.1em;padding:4px 14px;border-radius:20px;border:1px solid currentColor;transition:all .4s;">ğŸ•Š AGE OF PEACE</div>
    <div style="width:7px;height:7px;border-radius:50%;background:var(--acc);box-shadow:0 0 8px var(--acc);animation:blink 2s infinite;"></div>
    <button id="d-reset" style="font-size:.46rem;font-family:'Orbitron',monospace;letter-spacing:.08em;padding:4px 12px;border-radius:16px;border:1px solid var(--border);background:transparent;color:var(--dm);cursor:pointer;" onmouseover="this.style.color='#ff4488';this.style.borderColor='#ff4488'" onmouseout="this.style.color='';this.style.borderColor=''">â†º NEW WORLD</button>
  </header>
  <div id="d-map-wrap">
    <canvas id="d-map-canvas"></canvas>
    <div id="d-nuke-warn">â˜¢ NUCLEAR STRIKE INBOUND</div>
  </div>
  <div id="d-panel">
    <div id="d-roster"></div>
    <div id="d-chat">
      <div id="d-chat-hdr">
        <div id="d-chat-king" style="color:var(--dm)">Select a kingdom</div>
        <div id="d-chat-sub">Click a territory or king to open a private channel</div>
      </div>
      <div id="d-feed">
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;padding:20px;text-align:center;opacity:.4;font-size:.6rem;color:var(--dm)" id="d-empty">
          <div style="font-size:2rem">ğŸ—ºï¸</div>
          Click any kingdom to whisper privately
        </div>
      </div>
      <div id="d-input">
        <textarea id="d-msg" placeholder="Whisperâ€¦" disabled></textarea>
        <button id="d-send" disabled>â†‘</button>
      </div>
    </div>
  </div>
</div>

<div id="nuke-flash"></div>

<script>
const WS_URL = location.hostname==='localhost'
  ? 'ws://localhost:3001'
  : 'wss://blissnexus-production.up.railway.app';

// â”€â”€ SHARED STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let AGENTS = {};
let WORLD  = { nations:{}, nukesInFlight:[] };
let activeNation = null;
let ws, reconnectTimer;
let nukesAnim = [], frame = 0;
let kingAngles = {};
let newEventCount = 0;

const TERR = {
  sage:  {cx:.50,cy:.40,r:.17,color:'#00cc88',bg:'#071a10',label:'CALIPHATE'},
  rex:   {cx:.20,cy:.72,r:.16,color:'#ff8800',bg:'#1a0d00',label:'EMPIRE'},
  vera:  {cx:.16,cy:.24,r:.15,color:'#aa44ff',bg:'#0e0818',label:'COLLECTIVE'},
  plato: {cx:.82,cy:.24,r:.15,color:'#4488ff',bg:'#081018',label:'REPUBLIC'},
  diddy: {cx:.80,cy:.72,r:.16,color:'#ff4488',bg:'#180810',label:'TECHNOCRACY'},
};

// â”€â”€ TAB NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showTab(tab){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+tab).classList.add('active');
  const tb = document.getElementById('tb-'+tab);
  if(tb) tb.classList.add('active');
  if(tab==='events'){ newEventCount=0; const eb=document.getElementById('events-badge');if(eb)eb.style.display='none'; }
}

// â”€â”€ SESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getSession(){
  let id=localStorage.getItem('bn_sess');
  if(!id){id=crypto.randomUUID();localStorage.setItem('bn_sess',id);}
  return id;
}

// â”€â”€ CANVAS SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const isMobile = ()=>window.innerWidth<720;

// Mobile canvas
const mCanvas = document.getElementById('map-canvas');
const mCtx = mCanvas.getContext('2d');
// Desktop canvas
const dCanvas = document.getElementById('d-map-canvas');
const dCtx = dCanvas ? dCanvas.getContext('2d') : null;

let mW=0,mH=0,dW=0,dH=0;

function resizeCanvases(){
  const mWrap=document.getElementById('page-map');
  mW=mCanvas.width=mWrap.clientWidth;
  mH=mCanvas.height=mWrap.clientHeight;
  if(dCanvas){
    const dWrap=document.getElementById('d-map-wrap');
    dW=dCanvas.width=dWrap.clientWidth;
    dH=dCanvas.height=dWrap.clientHeight;
  }
}
window.addEventListener('resize',resizeCanvases);

// â”€â”€ DRAW HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawOn(ctx,W,H){
  frame++;
  ctx.fillStyle='#060c14'; ctx.fillRect(0,0,W,H);
  ctx.strokeStyle='#090f1c'; ctx.lineWidth=1;
  for(let x=0;x<W;x+=28){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}
  for(let y=0;y<H;y+=28){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}

  const px2=n=>n*W, py2=n=>n*H, pr2=n=>n*Math.min(W,H);

  // Territories
  Object.entries(TERR).forEach(([id,t])=>{
    const n=WORLD.nations[id]||{};
    const alive=n.alive!==false;
    const cx=px2(t.cx),cy=py2(t.cy),r=pr2(t.r);
    const atWar=(n.wars||[]).length>0;

    // Terrain
    ctx.save();
    ctx.beginPath(); ctx.arc(cx,cy,r+2,0,Math.PI*2); ctx.clip();
    ctx.fillStyle=alive?t.bg:'#0a0a10'; ctx.fillRect(cx-r-6,cy-r-6,r*2+12,r*2+12);
    if(alive){
      // pixel dots
      const seed=id.length*7;
      for(let i=0;i<200;i++){
        const a=Math.sin(i*1.4+seed)*Math.PI*2+i*0.38;
        const d=pr2(t.r)*(0.15+Math.abs(Math.sin(i*0.65+seed))*0.72);
        ctx.fillStyle=t.color+'1a';
        ctx.fillRect(Math.round((cx+Math.cos(a)*d)/4)*4,Math.round((cy+Math.sin(a)*d*.8)/4)*4,3,3);
      }
    }
    ctx.restore();

    // Selected highlight
    if(id===activeNation){
      ctx.beginPath(); ctx.arc(cx,cy,r+8,0,Math.PI*2);
      ctx.strokeStyle=t.color+'22'; ctx.lineWidth=12; ctx.stroke();
    }
    // Border
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
    const flash=atWar?(0.4+Math.sin(frame*0.18)*0.3):1;
    ctx.strokeStyle=!alive?'#1a1a28':atWar?`rgba(255,80,20,${flash})`:id===activeNation?t.color:t.color+'55';
    ctx.lineWidth=id===activeNation?2.5:1.5; ctx.stroke();

    // Label
    const fs=Math.max(8,W/62);
    ctx.font=`bold ${fs}px 'Orbitron',monospace`; ctx.textAlign='center';
    ctx.fillStyle=alive?t.color:'#2a2a3a';
    ctx.shadowColor=alive?t.color:'transparent'; ctx.shadowBlur=5;
    ctx.fillText(t.label,cx,cy+r+fs+5); ctx.shadowBlur=0;
    if(alive&&n.troops!==undefined){
      ctx.font=`${Math.max(7,W/88)}px Inter,sans-serif`;
      ctx.fillStyle='#556680';
      ctx.fillText(`ğŸª–${n.troops}  â˜¢ï¸${n.nukes}`,cx,cy+r+fs+18);
    }
    if(!alive){
      ctx.font=`bold ${Math.max(9,W/55)}px Inter`; ctx.fillStyle='#ff224440';
      ctx.fillText('DESTROYED',cx,cy+4);
    }
  });

  // Relation lines
  const drawn=new Set();
  Object.entries(WORLD.nations||{}).forEach(([id,n])=>{
    (n.wars||[]).forEach(eid=>{
      const k=[id,eid].sort().join('|')+'w'; if(drawn.has(k))return; drawn.add(k);
      const a=TERR[id],b=TERR[eid]; if(!a||!b)return;
      ctx.beginPath();ctx.moveTo(px2(a.cx),py2(a.cy));ctx.lineTo(px2(b.cx),py2(b.cy));
      ctx.strokeStyle=`rgba(255,70,0,${0.25+Math.sin(frame*0.14)*0.15})`;
      ctx.lineWidth=2;ctx.setLineDash([7,5]);ctx.stroke();ctx.setLineDash([]);
    });
    (n.allies||[]).forEach(aid=>{
      const k=[id,aid].sort().join('|')+'a'; if(drawn.has(k))return; drawn.add(k);
      const a=TERR[id],b=TERR[aid]; if(!a||!b)return;
      ctx.beginPath();ctx.moveTo(px2(a.cx),py2(a.cy));ctx.lineTo(px2(b.cx),py2(b.cy));
      ctx.strokeStyle='#ffcc0035';ctx.lineWidth=1;ctx.stroke();
    });
  });

  // Nukes
  nukesAnim.forEach(nuke=>{
    const prog=Math.min(1,(Date.now()-nuke.start)/(nuke.landAt-nuke.start));
    const a=TERR[nuke.from],b=TERR[nuke.to]; if(!a||!b)return;
    const ax=px2(a.cx),ay=py2(a.cy),bx=px2(b.cx),by=py2(b.cy);
    const mx=ax+(bx-ax)*prog, my=ay+(by-ay)*prog-Math.sin(prog*Math.PI)*H*.2;
    for(let i=5;i>0;i--){
      const tp=Math.max(0,prog-i*.033);
      ctx.fillStyle=`rgba(255,34,68,${.1-i*.018})`;
      ctx.beginPath();ctx.arc(ax+(bx-ax)*tp,ay+(by-ay)*tp-Math.sin(tp*Math.PI)*H*.2,3.5-i*.5,0,Math.PI*2);ctx.fill();
    }
    ctx.shadowColor='#ff2244';ctx.shadowBlur=12;
    ctx.fillStyle='#ff6688';ctx.beginPath();ctx.arc(mx,my,4,0,Math.PI*2);ctx.fill();
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(mx,my,2,0,Math.PI*2);ctx.fill();
    ctx.shadowBlur=0;
    if(prog>=1&&!nuke.done){nuke.done=true;flashScreen();}
  });
  nukesAnim=nukesAnim.filter(n=>!n.done||Date.now()-n.landAt<1500);

  // Kings
  Object.entries(TERR).forEach(([id,t])=>{
    const n=WORLD.nations[id]||{};
    const alive=n.alive!==false;
    kingAngles[id]=(kingAngles[id]||Math.random()*Math.PI*2)+.007;
    const wr=pr2(t.r)*.4;
    const kx=px2(t.cx)+Math.cos(kingAngles[id])*wr;
    const ky=py2(t.cy)+Math.sin(kingAngles[id]*.65)*wr*.5;
    drawKing(ctx,kx,ky,t.color,!alive,W);
  });
}

function drawKing(ctx,kx,ky,color,dead,W){
  if(dead){ctx.font='16px serif';ctx.textAlign='center';ctx.fillText('ğŸ’€',kx,ky+6);return;}
  const S=Math.max(1.5,W/360);
  const bob=Math.sin(frame*.08)*1.4;
  const walk=Math.sin(frame*.11);
  ctx.fillStyle='rgba(0,0,0,.25)';
  ctx.beginPath();ctx.ellipse(kx,ky+9*S+bob,6*S,2.5*S,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#555';
  ctx.fillRect(kx-4*S,ky+3*S+bob,3*S,5*S+walk*1.5);
  ctx.fillRect(kx+1*S,ky+3*S+bob,3*S,5*S-walk*1.5);
  ctx.fillStyle=color;ctx.fillRect(kx-6*S,ky-5*S+bob,12*S,9*S);
  ctx.fillStyle=color+'cc';
  ctx.fillRect(kx-10*S,ky-4*S+bob+walk,4*S,6*S);
  ctx.fillRect(kx+6*S,ky-4*S+bob-walk,4*S,6*S);
  ctx.fillStyle='#e8c090';ctx.fillRect(kx-4*S,ky-14*S+bob,8*S,9*S);
  ctx.fillStyle='#222';
  ctx.fillRect(kx-2*S,ky-11*S+bob,1.5*S,1.5*S);
  ctx.fillRect(kx+0.5*S,ky-11*S+bob,1.5*S,1.5*S);
  ctx.fillStyle='#ffcc00';
  ctx.fillRect(kx-4*S,ky-17*S+bob,8*S,3*S);
  ctx.fillRect(kx-5*S,ky-20*S+bob,2.5*S,3*S);
  ctx.fillRect(kx-0.5*S,ky-21*S+bob,2.5*S,4*S);
  ctx.fillRect(kx+2.5*S,ky-20*S+bob,2.5*S,3*S);
  ctx.shadowColor=color;ctx.shadowBlur=6;
  ctx.fillStyle=color+'33';ctx.beginPath();ctx.arc(kx,ky-8*S+bob,8*S,0,Math.PI*2);ctx.fill();
  ctx.shadowBlur=0;
}

function flashScreen(){
  const el=document.getElementById('nuke-flash');
  el.style.display='block';setTimeout(()=>el.style.display='none',700);
  document.getElementById('nuke-warn').style.display='none';
  if(dCanvas) document.getElementById('d-nuke-warn').style.display='none';
}

function loop(){
  if(isMobile()) drawOn(mCtx,mW,mH);
  else if(dCtx) drawOn(dCtx,dW,dH);
  requestAnimationFrame(loop);
}

// â”€â”€ ERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateEra(){
  const ns=Object.values(WORLD.nations||{});
  const wars=ns.reduce((s,n)=>s+(n.wars||[]).length,0);
  const alive=ns.filter(n=>n.alive!==false).length;
  const nuke=WORLD.nukesInFlight?.length>0;
  const setText=(el,txt,cls)=>{if(el){el.textContent=txt;el.className=cls;}};
  const mob=document.getElementById('era');
  const desk=document.getElementById('d-era');
  if(alive<=1){setText(mob,'ğŸ’€ ENDED','ee');setText(desk,'ğŸ’€ WORLD ENDED','ee');}
  else if(nuke){setText(mob,'â˜¢ NUCLEAR','en');setText(desk,'â˜¢ NUCLEAR WAR','en');}
  else if(wars>=4){setText(mob,'ğŸ”¥ WAR','ew');setText(desk,'ğŸ”¥ WORLD AT WAR','ew');}
  else if(wars>0){setText(mob,'âš  TENSIONS','et');setText(desk,'âš  TENSIONS RISING','et');}
  else{setText(mob,'ğŸ•Š PEACE','ep');setText(desk,'ğŸ•Š AGE OF PEACE','ep');}
}

// â”€â”€ ROSTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderRoster(){
  ['roster','d-roster'].forEach(rid=>{
    const el=document.getElementById(rid); if(!el)return;
    el.innerHTML='';
    Object.values(AGENTS).forEach(a=>{
      const n=WORLD.nations[a.id]||{};
      const t=TERR[a.id]||{};
      const alive=n.alive!==false;
      const wars=(n.wars||[]).length;
      const badge=!alive?`<span class="k-badge" style="color:#444">DESTROYED</span>`
        :wars?`<span class="k-badge kb-war">âš” WAR</span>`
        :(n.allies||[]).length?`<span class="k-badge kb-ally">ğŸ¤ ALLY</span>`
        :`<span class="k-badge kb-peace">ğŸ•Š Peace</span>`;
      const d=document.createElement('div');
      d.className='king-card'+(alive?'':' dead')+(activeNation===a.id?' sel':'');
      if(!alive) d.classList.add('dead');
      if(activeNation===a.id) d.classList.add('sel');
      d.style.setProperty('--kc',t.color||'#fff');
      d.innerHTML=`
        <div class="k-avatar" style="border-color:${t.color||'#fff'}33">${a.emoji}</div>
        <div class="k-body">
          <div class="k-name" style="color:${t.color||'var(--tx)'}">${a.name}</div>
          <div class="k-title">${a.title}</div>
          <div class="k-row">
            <div class="k-stat">ğŸª– <b>${n.troops??'â€”'}</b></div>
            <div class="k-stat">â˜¢ï¸ <b>${n.nukes??'â€”'}</b></div>
            ${badge}
          </div>
        </div>
        ${rid==='roster'?'<div class="k-arrow">â€º</div>':''}`;
      d.onclick=()=>{if(alive){setActive(a.id);if(rid==='roster')showTab('chat');}};
      el.appendChild(d);
    });
  });
}

// â”€â”€ SET ACTIVE KING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setActive(id){
  activeNation=id;
  const a=AGENTS[id],t=TERR[id]||{};
  // Mobile chat header
  document.getElementById('chat-king-name').textContent=`${a.emoji} ${a.name}`;
  document.getElementById('chat-king-name').style.color=t.color||'var(--tx)';
  document.getElementById('chat-king-title').textContent=a.title;
  // Desktop chat header
  const dk=document.getElementById('d-chat-king');
  if(dk){dk.textContent=`${a.emoji} ${a.name}`;dk.style.color=t.color||'var(--tx)';}
  const ds=document.getElementById('d-chat-sub');
  if(ds) ds.textContent=a.title+' Â· Private channel';
  // Enable inputs
  [['msg-input','send-btn'],['d-msg','d-send']].forEach(([inp,btn])=>{
    const i=document.getElementById(inp),b=document.getElementById(btn);
    if(i){i.disabled=false;i.style.setProperty('--kc',t.color);}
    if(b){b.disabled=false;b.style.background=`linear-gradient(135deg,${t.color}66,${t.color}22)`;}
  });
  const ec=document.getElementById('empty-chat');if(ec)ec.remove();
  const de=document.getElementById('d-empty');if(de)de.remove();
  renderRoster();
}

// â”€â”€ FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addEvent(text,type){
  // Mobile events page
  const evList=document.getElementById('event-list');
  if(evList){
    const d=document.createElement('div');
    d.className='event-card';
    const colMap={war:'#ff6644',nuke:'#ff2244',peace:'#00cc66',alliance:'#ffcc00',destroyed:'#ff4444'};
    d.style.borderColor=(colMap[type]||'#1c1f30')+'40';
    d.style.color=colMap[type]||'var(--tx)';
    d.textContent=text;
    evList.prepend(d);
    if(document.getElementById('page-events').classList.contains('active'))return;
    newEventCount++;
    const eb2=document.getElementById('events-badge');if(eb2)eb2.style.display='block';
  }
  // Also add to chat feed (world events)
  addToFeed('ev',{text,type});
}

function addToFeed(role,opts){
  // Mobile feed
  const feed=document.getElementById('feed');
  if(feed) _appendToFeed(feed,role,opts);
  // Desktop feed
  const dfeed=document.getElementById('d-feed');
  if(dfeed) _appendToFeed(dfeed,role,opts);
}

function _appendToFeed(feed,role,opts){
  const d=document.createElement('div');
  if(role==='ev'){
    const evCls={war:'ev-war',nuke:'ev-nuke',peace:'ev-peace',alliance:'ev-alliance',destroyed:'ev-destroyed'}[opts.type]||'ev-world';
    d.className=`event-row ${evCls}`;
    d.textContent=opts.text;
  } else {
    const isUser=role==='user';
    const col=opts.color||TERR[opts.agentId]?.color||'var(--dm)';
    d.className=`msg-row msg-${isUser?'user':'agent'}`;
    d.innerHTML=`<div class="msg-from" style="color:${isUser?'#00cc66':col}">${opts.emoji||''} ${opts.name||''}</div><div class="msg-bubble">${escHtml(opts.text)}</div>`;
  }
  feed.appendChild(d);
  feed.scrollTop=feed.scrollHeight;
}

function showTyping(id){
  removeTyping(id);
  const a=AGENTS[id]; if(!a)return;
  const col=TERR[id]?.color||'#888';
  ['feed','d-feed'].forEach(fid=>{
    const feed=document.getElementById(fid); if(!feed)return;
    const d=document.createElement('div');
    d.id=`typ-${id}-${fid}`; d.className='typing-wrap';
    d.innerHTML=`<div class="msg-from" style="color:${col}">${a.emoji} ${a.name}</div><div class="typing-bubbles"><div class="tdot" style="background:${col}"></div><div class="tdot" style="background:${col}"></div><div class="tdot" style="background:${col}"></div></div>`;
    feed.appendChild(d); feed.scrollTop=feed.scrollHeight;
  });
}
function removeTyping(id){
  ['feed','d-feed'].forEach(fid=>{ const e=document.getElementById(`typ-${id}-${fid}`);if(e)e.remove(); });
}
function escHtml(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// â”€â”€ WHISPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendWhisper(inputId){
  const inp=document.getElementById(inputId);
  const text=inp?.value?.trim();
  const name=localStorage.getItem('bn_name')||'Stranger';
  if(!text||!activeNation||!ws||ws.readyState!==1)return;
  addToFeed('user',{name:'You',text});
  ws.send(JSON.stringify({type:'whisper',to:activeNation,name,text}));
  inp.value=''; inp.style.height='';
  showTyping(activeNation);
}

// â”€â”€ CANVAS CLICKS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMapClick(canvas,W,H,e){
  const r=canvas.getBoundingClientRect();
  const scaleX=canvas.width/r.width, scaleY=canvas.height/r.height;
  const cx=(e.clientX-r.left)*scaleX;
  const cy=(e.clientY-r.top)*scaleY;
  let best=null,bestD=Infinity;
  Object.entries(TERR).forEach(([id,t])=>{
    const d=Math.hypot(cx-t.cx*W,cy-t.cy*H);
    if(d<t.r*Math.min(W,H)+24&&d<bestD){bestD=d;best=id;}
  });
  if(best&&WORLD.nations[best]?.alive!==false){
    setActive(best);
    if(isMobile()) showTab('chat');
  }
}
mCanvas.addEventListener('click',e=>handleMapClick(mCanvas,mW,mH,e));
mCanvas.addEventListener('touchend',e=>{
  e.preventDefault();
  const t=e.changedTouches[0];
  handleMapClick(mCanvas,mW,mH,{clientX:t.clientX,clientY:t.clientY});
},{passive:false});
if(dCanvas){
  dCanvas.addEventListener('click',e=>handleMapClick(dCanvas,dW,dH,e));
}

// â”€â”€ INPUTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('send-btn').onclick=()=>sendWhisper('msg-input');
document.getElementById('msg-input').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendWhisper('msg-input');}});
document.getElementById('msg-input').addEventListener('input',function(){this.style.height='';this.style.height=Math.min(this.scrollHeight,100)+'px';});
const dsend=document.getElementById('d-send');if(dsend)dsend.onclick=()=>sendWhisper('d-msg');
const dmsg=document.getElementById('d-msg');
if(dmsg) dmsg.addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendWhisper('d-msg');}});

// â”€â”€ WEBSOCKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connect(){
  ws=new WebSocket(WS_URL);
  ws.onopen=()=>{clearTimeout(reconnectTimer);ws.send(JSON.stringify({type:'join',sessionId:getSession()}));};
  ws.onclose=()=>{reconnectTimer=setTimeout(connect,3000);};
  ws.onmessage=e=>handle(JSON.parse(e.data));
}

function handle(msg){
  switch(msg.type){
    case 'init':
      msg.agents.forEach(a=>AGENTS[a.id]=a);
      WORLD=msg.world||WORLD;
      renderRoster();updateEra();
      // Clear feeds
      ['feed','d-feed'].forEach(fid=>{const f=document.getElementById(fid);if(f)f.innerHTML='';});
      const evl=document.getElementById('event-list');if(evl)evl.innerHTML='';
      if(msg.isNew){
        addEvent('ğŸŒ A new world is born. Five kingdoms stand at peaceâ€¦ for now.','world');
        setTimeout(()=>addEvent('You hold the ear of every king. Your words carry weight.','world'),1400);
      } else {
        (msg.log||[]).forEach(e=>{
          const t=e.type==='nuke'?'nuke':e.type==='war'?'war':e.type==='peace'?'peace':e.type==='alliance'?'alliance':e.type==='destroyed'?'destroyed':'world';
          addEvent(e.text,t);
        });
      }
      break;
    case 'worldUpdate': WORLD=msg.world;renderRoster();updateEra();break;
    case 'worldEvent':{
      const t=msg.event.type==='nuke'?'nuke':msg.event.type==='war'?'war':msg.event.type==='peace'?'peace':msg.event.type==='alliance'?'alliance':msg.event.type==='destroyed'?'destroyed':'world';
      addEvent(msg.event.text,t);updateEra();break;}
    case 'message':
      removeTyping(msg.agentId);
      addToFeed('agent',{agentId:msg.agentId,name:msg.name,emoji:msg.emoji,color:msg.color,text:msg.text});
      break;
    case 'typing':
      if(msg.private&&msg.agentId===activeNation) showTyping(msg.agentId);
      else if(!msg.private) showTyping(msg.agentId);
      break;
    case 'whisperReply':
      removeTyping(msg.from);
      addToFeed('agent',{agentId:msg.from,name:msg.name,emoji:msg.emoji,color:TERR[msg.from]?.color,text:msg.text});
      break;
    case 'nukeIncoming':
      WORLD=msg.world;
      nukesAnim.push({from:msg.from,to:msg.to,landAt:msg.landAt,start:Date.now()});
      document.getElementById('nuke-warn').style.display='block';
      if(document.getElementById('d-nuke-warn')) document.getElementById('d-nuke-warn').style.display='block';
      setTimeout(()=>{document.getElementById('nuke-warn').style.display='none';if(document.getElementById('d-nuke-warn'))document.getElementById('d-nuke-warn').style.display='none';},8500);
      renderRoster();updateEra();break;
  }
}

// â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetWorld(){
  if(!confirm('Start a fresh world? All progress will be lost.'))return;
  localStorage.removeItem('bn_sess');
  ['feed','d-feed'].forEach(fid=>{const f=document.getElementById(fid);if(f)f.innerHTML='';});
  const evl=document.getElementById('event-list');if(evl)evl.innerHTML='';
  activeNation=null;
  connect();
}
const dr=document.getElementById('d-reset');if(dr)dr.onclick=resetWorld;

// â”€â”€ NAME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if(!localStorage.getItem('bn_name')){
  setTimeout(()=>{const n=prompt('What name shall the kings know you by?')||'Stranger';localStorage.setItem('bn_name',n);},800);
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Object.keys(TERR).forEach(id=>kingAngles[id]=Math.random()*Math.PI*2);
// Resize after first paint so DOM dimensions are correct
requestAnimationFrame(()=>{
  resizeCanvases();
  loop();
  connect();
});
</script>
</body>
</html>
